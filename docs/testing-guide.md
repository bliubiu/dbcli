# dbcli 测试验证指南

## 概述

本文档描述了dbcli项目的完整测试验证体系，包括单元测试、集成测试和测试运行工具。

## 测试架构

### 测试分类

1. **单元测试 (Unit Tests)**
   - 测试单个类或方法的功能
   - 不依赖外部资源（数据库、文件系统等）
   - 快速执行，提供即时反馈

2. **集成测试 (Integration Tests)**
   - 测试多个组件之间的交互
   - 可能涉及文件系统、配置文件等
   - 验证端到端功能

### 测试覆盖范围

#### 单元测试覆盖的模块：

**配置管理模块**
- `ConfigLoaderTest` - 测试YAML配置文件加载和解析
- 验证配置文件格式正确性
- 测试错误配置的处理

**数据安全模块**
- `EncryptionUtilTest` - 测试SM4加密解密功能
- `DataMaskUtilTest` - 测试敏感数据脱敏功能
- 验证加密密钥管理

**数据库连接模块**
- `ConnectionFactoryTest` - 测试数据库连接字符串构建
- 支持Oracle、MySQL、PostgreSQL、达梦数据库
- 验证连接参数正确性

**模板服务模块**
- `TemplateServiceTest` - 测试配置模板生成功能
- 验证模板文件内容和格式
- 测试目录结构创建

**数据模型模块**
- `MetricResultTest` - 测试指标结果数据模型
- 验证单值和多值指标处理
- 测试阈值判断逻辑

#### 集成测试覆盖的功能：

**应用程序集成**
- `DbCliIntegrationTest` - 测试完整应用程序流程
- 命令行参数解析验证
- 配置文件验证
- 模板生成功能测试

## 测试工具

### 测试运行器

提供了跨平台的测试运行脚本：

**Linux/macOS: `test-runner.sh`**
```bash
# 运行所有测试
./test-runner.sh

# 只运行单元测试
./test-runner.sh -t unit

# 只运行集成测试
./test-runner.sh -t integration

# 显示详细输出
./test-runner.sh -v

# 跳过构建直接测试
./test-runner.sh --skip-build
```

**Windows: `test-runner.bat`**
```cmd
REM 运行所有测试
test-runner.bat

REM 只运行单元测试
test-runner.bat -t unit

REM 只运行集成测试
test-runner.bat -t integration

REM 显示详细输出
test-runner.bat -v
```

### 测试报告

测试运行后会生成详细的测试报告：

- **报告位置**: `target/surefire-reports/`
- **报告格式**: XML和TXT格式
- **包含信息**: 测试结果、执行时间、错误详情

## 测试执行流程

### 1. 环境检查
- 验证Java环境（Java 8+）
- 验证Maven环境（Maven 3.6+）
- 检查项目结构完整性

### 2. 项目构建
- 清理旧的构建文件
- 编译源代码和测试代码
- 下载依赖包

### 3. 测试执行
- 按照指定类型运行测试
- 生成测试报告
- 统计测试结果

### 4. 结果分析
- 显示测试统计信息
- 提供故障排除建议
- 生成详细报告文件

## 测试最佳实践

### 编写测试用例

1. **命名规范**
   - 测试类名以`Test`结尾
   - 集成测试类名以`IntegrationTest`结尾
   - 测试方法名应描述测试场景

2. **测试结构**
   - 使用`@Before`进行测试前准备
   - 使用`@After`进行测试后清理
   - 每个测试方法应独立运行

3. **断言使用**
   - 使用有意义的断言消息
   - 验证预期结果和异常情况
   - 测试边界条件和错误处理

### 测试数据管理

1. **临时文件**
   - 使用临时目录存储测试文件
   - 测试结束后自动清理
   - 避免测试间相互影响

2. **配置隔离**
   - 使用独立的测试配置
   - 不依赖生产环境配置
   - 模拟外部依赖

## 持续集成

### 自动化测试

建议在以下情况下运行测试：

1. **代码提交前**
   ```bash
   ./test-runner.sh -t unit
   ```

2. **构建发布前**
   ```bash
   ./test-runner.sh
   ```

3. **部署验证**
   ```bash
   ./test-runner.sh -t integration
   ```

### 测试覆盖率

虽然当前项目没有集成覆盖率工具，但建议：

1. 关键业务逻辑应有完整测试覆盖
2. 异常处理路径应有测试验证
3. 边界条件应有专门测试

## 故障排除

### 常见问题

1. **测试环境问题**
   - 检查Java和Maven版本
   - 验证环境变量设置
   - 确保网络连接正常

2. **测试失败分析**
   - 查看详细错误日志
   - 检查测试报告文件
   - 验证测试数据正确性

3. **性能问题**
   - 使用`--skip-build`跳过重复构建
   - 运行特定类型测试减少时间
   - 检查临时文件清理

### 调试技巧

1. **单独运行失败测试**
   ```bash
   mvn test -Dtest=TestClassName#testMethodName
   ```

2. **启用详细日志**
   ```bash
   ./test-runner.sh -v
   ```

3. **保留测试数据**
   - 注释掉清理代码
   - 检查生成的临时文件
   - 验证测试环境状态

## 扩展测试

### 添加新测试

1. **创建测试类**
   - 放在`src/test/java`目录下
   - 遵循包结构约定
   - 继承适当的测试基类

2. **编写测试方法**
   - 使用JUnit 4注解
   - 包含正常和异常场景
   - 添加有意义的断言

3. **运行验证**
   - 使用测试运行器验证
   - 检查测试报告
   - 确保测试稳定性

### 性能测试

虽然当前主要关注功能测试，但可以扩展：

1. **数据库连接性能测试**
2. **大数据量查询测试**
3. **并发执行性能测试**
4. **内存使用情况测试**

## 总结

dbcli项目的测试验证体系提供了：

- ✅ 完整的单元测试覆盖
- ✅ 端到端集成测试
- ✅ 跨平台测试运行工具
- ✅ 详细的测试报告
- ✅ 自动化测试流程
- ✅ 故障排除指南

通过这套测试体系，可以确保dbcli项目的质量和稳定性，为生产环境部署提供可靠保障。