# DBCLI 监控集成功能说明

## 📋 功能概述

DBCLI 提供了完整的监控集成解决方案，支持高亮指标值的自动告警生成和多种监控系统对接模式。

## 🚨 告警条目生成功能

### 核心特性

#### 1. 智能告警检测
- **高亮指标识别**: 自动检测MetricResult中的高亮指标值
- **多级告警**: 支持CRITICAL(严重)、WARNING(警告)、INFO(信息)三个级别
- **动态阈值**: 可配置的告警阈值和消息模板
- **上下文信息**: 包含系统名称、数据库名、节点IP等完整上下文

#### 2. 告警条目结构
```java
AlertItem {
    alertId: "ALERT_1694234567890_a1b2c3d4",     // 唯一告警ID
    level: CRITICAL,                              // 告警级别
    systemName: "生产环境Oracle集群",              // 系统名称
    databaseName: "ORCL",                        // 数据库名
    nodeIp: "192.168.1.100",                     // 节点IP
    metricDescription: "CPU使用率",               // 指标描述
    metricValue: "95.5%",                        // 指标值
    alertMessage: "CPU使用率过高 (当前值: 95.5%)", // 告警消息
    timestamp: "2024-09-10 08:30:15",            // 时间戳
    metadata: {...}                              // 元数据
}
```

#### 3. 告警规则配置
```yaml
# configs/monitoring-config.yml
alertRules:
  cpu_usage:
    critical:
      threshold: 90.0
      message: "CPU使用率过高"
    warning:
      threshold: 80.0
      message: "CPU使用率较高"
```

### 使用示例

```java
// 创建告警生成器
AlertItemGenerator generator = new AlertItemGenerator();

// 处理指标结果
List<MetricResult> results = executeMetrics();
List<AlertItem> alerts = generator.generateAlertItems(
    "生产环境Oracle集群", "ORCL", "192.168.1.100", results);

// 输出告警条目
for (AlertItem alert : alerts) {
    System.out.println(alert.toString());
    // [严重] 2024-09-10 08:30:15 - 生产环境Oracle集群@ORCL:192.168.1.100 - CPU使用率=95.5% - CPU使用率过高 (当前值: 95.5%)
}
```

## 🔧 监控集成模式

### 模式一：内置监控栈 (EMBEDDED)

**适用场景**: 新建项目、独立部署、完全控制监控栈

**架构组件**:
- **Prometheus**: 指标收集和存储
- **AlertManager**: 告警管理和通知
- **Grafana**: 可视化面板和仪表板

**配置示例**:
```yaml
monitoring:
  mode: EMBEDDED
  
embedded:
  prometheus:
    url: "http://localhost:9090"
    enabled: true
  alertmanager:
    url: "http://localhost:9093"
    enabled: true
  grafana:
    url: "http://localhost:3000"
    enabled: true
```

**部署方式**:
```bash
# 使用Docker Compose一键部署
docker-compose up -d

# 访问监控面板
# Prometheus: http://localhost:9090
# AlertManager: http://localhost:9093
# Grafana: http://localhost:3000
```

**优势**:
- ✅ 开箱即用，无需额外配置
- ✅ 完整的监控生态系统
- ✅ 丰富的可视化面板
- ✅ 强大的告警规则引擎

### 模式二：外部监控栈 (EXTERNAL)

**适用场景**: 企业环境、已有监控系统、统一监控管理

**支持的外部系统**:
- **Zabbix**: 企业级监控解决方案
- **Nagios**: 传统网络监控系统
- **企业监控平台**: 自研或商业监控系统
- **云监控服务**: 阿里云、腾讯云等云监控

**配置示例**:
```yaml
monitoring:
  mode: EXTERNAL
  
external:
  endpoints:
    # 企业监控平台
    enterprise_monitor:
      url: "http://monitor.company.com/api"
      enabled: true
      headers:
        Authorization: "Bearer your-token-here"
    
    # Zabbix集成
    zabbix:
      url: "http://zabbix.company.com/api_jsonrpc.php"
      enabled: true
      config:
        user: "dbcli"
        password: "password"
```

**集成方式**:
```java
// 告警数据格式
{
  "alerts": [
    {
      "alertId": "ALERT_1694234567890_a1b2c3d4",
      "level": "CRITICAL",
      "systemName": "生产环境Oracle集群",
      "databaseName": "ORCL",
      "nodeIp": "192.168.1.100",
      "metricDescription": "CPU使用率",
      "metricValue": "95.5%",
      "alertMessage": "CPU使用率过高 (当前值: 95.5%)",
      "timestamp": "2024-09-10T08:30:15Z"
    }
  ],
  "timestamp": 1694234567890,
  "source": "dbcli"
}
```

**优势**:
- ✅ 无缝集成现有监控体系
- ✅ 统一的告警管理
- ✅ 符合企业IT治理要求
- ✅ 减少监控系统维护成本

### 模式三：混合模式 (HYBRID)

**适用场景**: 渐进式迁移、多环境部署、灵活监控策略

**特点**:
- 同时支持内置和外部监控栈
- 可以将不同类型的告警发送到不同系统
- 支持监控系统的平滑迁移

**配置示例**:
```yaml
monitoring:
  mode: HYBRID
  
embedded:
  prometheus:
    url: "http://localhost:9090"
    enabled: true
    
external:
  endpoints:
    enterprise_monitor:
      url: "http://monitor.company.com/api"
      enabled: true
```

## 📊 监控数据流程

### 1. 指标收集阶段
```
数据库查询 → MetricResult → 高亮值检测 → 告警条目生成
```

### 2. 告警处理阶段
```
AlertItem生成 → 告警规则匹配 → 级别判定 → 消息格式化
```

### 3. 监控集成阶段
```
告警条目 → 适配器转换 → 监控系统API → 告警通知
```

## 🔍 监控面板和可视化

### Grafana仪表板

**数据库概览面板**:
- 数据库连接状态
- 关键性能指标趋势
- 资源使用率统计
- 告警状态概览

**性能监控面板**:
- 响应时间分析
- 吞吐量统计
- 慢查询监控
- 锁等待分析

**告警管理面板**:
- 实时告警列表
- 告警趋势分析
- 告警级别分布
- 系统健康评分

### 自定义面板配置
```yaml
dashboards:
  autoCreate: true
  panels:
    - name: "数据库概览"
      file: "database-overview.json"
      enabled: true
    - name: "性能监控"
      file: "performance-monitoring.json"
      enabled: true
```

## 🚀 快速开始

### 1. 启用监控集成
```java
// 在DbCliRunner中集成监控服务
MonitoringIntegrationService monitoringService = new MonitoringIntegrationService();

// 处理指标结果
CompletableFuture<ProcessResult> result = monitoringService.processMetricResults(
    systemName, databaseName, nodeIp, metricResults);
```

### 2. 配置告警规则
```bash
# 编辑监控配置文件
vim configs/monitoring-config.yml

# 添加自定义告警规则
alertRules:
  custom_metric:
    critical:
      threshold: 100.0
      message: "自定义指标异常"
```

### 3. 验证监控功能
```bash
# 发送测试告警
curl -X POST http://localhost:8080/api/monitoring/test-alert

# 查看监控状态
curl http://localhost:8080/api/monitoring/status
```

## 📈 监控效果

### 告警响应时间
- **检测延迟**: < 30秒
- **告警生成**: < 5秒
- **通知发送**: < 10秒

### 监控覆盖率
- **系统指标**: CPU、内存、磁盘、网络
- **数据库指标**: 连接数、响应时间、锁等待、表空间
- **应用指标**: 执行成功率、错误率、性能统计

### 可靠性保证
- **故障转移**: 监控系统故障时自动切换
- **数据持久化**: 告警历史和指标数据持久存储
- **健康检查**: 定期检查监控组件状态

## 🛠️ 运维管理

### 监控系统维护
```bash
# 检查监控系统健康状态
java -jar dbcli.jar --monitoring-health

# 重启监控服务
java -jar dbcli.jar --restart-monitoring

# 导出监控配置
java -jar dbcli.jar --export-monitoring-config
```

### 告警规则管理
```bash
# 热重载告警规则
java -jar dbcli.jar --reload-alert-rules

# 验证告警规则
java -jar dbcli.jar --validate-alert-rules

# 测试告警发送
java -jar dbcli.jar --test-alerts
```

## 📝 最佳实践

### 1. 告警规则设计
- **分级设置**: 合理设置CRITICAL和WARNING阈值
- **避免告警风暴**: 设置告警抑制和分组规则
- **上下文丰富**: 提供足够的告警上下文信息

### 2. 监控系统选择
- **内置模式**: 适合新项目和独立部署
- **外部模式**: 适合企业环境和统一管理
- **混合模式**: 适合渐进式迁移和多环境部署

### 3. 性能优化
- **批量处理**: 批量发送告警减少网络开销
- **异步处理**: 使用异步方式避免阻塞主流程
- **缓存机制**: 缓存监控配置减少文件读取

## 🔧 故障排查

### 常见问题

**Q: 告警没有发送到监控系统**
A: 检查监控配置、网络连接和认证信息

**Q: Grafana面板显示无数据**
A: 确认Prometheus数据源配置和指标名称

**Q: 告警规则不生效**
A: 验证配置文件格式和重载配置

### 日志分析
```bash
# 查看监控日志
tail -f logs/monitoring.log

# 查看告警生成日志
grep "AlertItem" logs/application.log

# 查看监控集成日志
grep "MonitoringIntegration" logs/application.log
```

---

通过以上监控集成功能，DBCLI 实现了从指标收集到告警通知的完整监控链路，为数据库运维提供了强大的监控支持。