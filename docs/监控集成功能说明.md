# DBCLI ç›‘æ§é›†æˆåŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

DBCLI æä¾›äº†å®Œæ•´çš„ç›‘æ§é›†æˆè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒé«˜äº®æŒ‡æ ‡å€¼çš„è‡ªåŠ¨å‘Šè­¦ç”Ÿæˆå’Œå¤šç§ç›‘æ§ç³»ç»Ÿå¯¹æ¥æ¨¡å¼ã€‚

## ğŸš¨ å‘Šè­¦æ¡ç›®ç”ŸæˆåŠŸèƒ½

### æ ¸å¿ƒç‰¹æ€§

#### 1. æ™ºèƒ½å‘Šè­¦æ£€æµ‹
- **é«˜äº®æŒ‡æ ‡è¯†åˆ«**: è‡ªåŠ¨æ£€æµ‹MetricResultä¸­çš„é«˜äº®æŒ‡æ ‡å€¼
- **å¤šçº§å‘Šè­¦**: æ”¯æŒCRITICAL(ä¸¥é‡)ã€WARNING(è­¦å‘Š)ã€INFO(ä¿¡æ¯)ä¸‰ä¸ªçº§åˆ«
- **åŠ¨æ€é˜ˆå€¼**: å¯é…ç½®çš„å‘Šè­¦é˜ˆå€¼å’Œæ¶ˆæ¯æ¨¡æ¿
- **ä¸Šä¸‹æ–‡ä¿¡æ¯**: åŒ…å«ç³»ç»Ÿåç§°ã€æ•°æ®åº“åã€èŠ‚ç‚¹IPç­‰å®Œæ•´ä¸Šä¸‹æ–‡

#### 2. å‘Šè­¦æ¡ç›®ç»“æ„
```java
AlertItem {
    alertId: "ALERT_1694234567890_a1b2c3d4",     // å”¯ä¸€å‘Šè­¦ID
    level: CRITICAL,                              // å‘Šè­¦çº§åˆ«
    systemName: "ç”Ÿäº§ç¯å¢ƒOracleé›†ç¾¤",              // ç³»ç»Ÿåç§°
    databaseName: "ORCL",                        // æ•°æ®åº“å
    nodeIp: "192.168.1.100",                     // èŠ‚ç‚¹IP
    metricDescription: "CPUä½¿ç”¨ç‡",               // æŒ‡æ ‡æè¿°
    metricValue: "95.5%",                        // æŒ‡æ ‡å€¼
    alertMessage: "CPUä½¿ç”¨ç‡è¿‡é«˜ (å½“å‰å€¼: 95.5%)", // å‘Šè­¦æ¶ˆæ¯
    timestamp: "2024-09-10 08:30:15",            // æ—¶é—´æˆ³
    metadata: {...}                              // å…ƒæ•°æ®
}
```

#### 3. å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# configs/monitoring-config.yml
alertRules:
  cpu_usage:
    critical:
      threshold: 90.0
      message: "CPUä½¿ç”¨ç‡è¿‡é«˜"
    warning:
      threshold: 80.0
      message: "CPUä½¿ç”¨ç‡è¾ƒé«˜"
```

### ä½¿ç”¨ç¤ºä¾‹

```java
// åˆ›å»ºå‘Šè­¦ç”Ÿæˆå™¨
AlertItemGenerator generator = new AlertItemGenerator();

// å¤„ç†æŒ‡æ ‡ç»“æœ
List<MetricResult> results = executeMetrics();
List<AlertItem> alerts = generator.generateAlertItems(
    "ç”Ÿäº§ç¯å¢ƒOracleé›†ç¾¤", "ORCL", "192.168.1.100", results);

// è¾“å‡ºå‘Šè­¦æ¡ç›®
for (AlertItem alert : alerts) {
    System.out.println(alert.toString());
    // [ä¸¥é‡] 2024-09-10 08:30:15 - ç”Ÿäº§ç¯å¢ƒOracleé›†ç¾¤@ORCL:192.168.1.100 - CPUä½¿ç”¨ç‡=95.5% - CPUä½¿ç”¨ç‡è¿‡é«˜ (å½“å‰å€¼: 95.5%)
}
```

## ğŸ”§ ç›‘æ§é›†æˆæ¨¡å¼

### æ¨¡å¼ä¸€ï¼šå†…ç½®ç›‘æ§æ ˆ (EMBEDDED)

**é€‚ç”¨åœºæ™¯**: æ–°å»ºé¡¹ç›®ã€ç‹¬ç«‹éƒ¨ç½²ã€å®Œå…¨æ§åˆ¶ç›‘æ§æ ˆ

**æ¶æ„ç»„ä»¶**:
- **Prometheus**: æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨
- **AlertManager**: å‘Šè­¦ç®¡ç†å’Œé€šçŸ¥
- **Grafana**: å¯è§†åŒ–é¢æ¿å’Œä»ªè¡¨æ¿

**é…ç½®ç¤ºä¾‹**:
```yaml
monitoring:
  mode: EMBEDDED
  
embedded:
  prometheus:
    url: "http://localhost:9090"
    enabled: true
  alertmanager:
    url: "http://localhost:9093"
    enabled: true
  grafana:
    url: "http://localhost:3000"
    enabled: true
```

**éƒ¨ç½²æ–¹å¼**:
```bash
# ä½¿ç”¨Docker Composeä¸€é”®éƒ¨ç½²
docker-compose up -d

# è®¿é—®ç›‘æ§é¢æ¿
# Prometheus: http://localhost:9090
# AlertManager: http://localhost:9093
# Grafana: http://localhost:3000
```

**ä¼˜åŠ¿**:
- âœ… å¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… å®Œæ•´çš„ç›‘æ§ç”Ÿæ€ç³»ç»Ÿ
- âœ… ä¸°å¯Œçš„å¯è§†åŒ–é¢æ¿
- âœ… å¼ºå¤§çš„å‘Šè­¦è§„åˆ™å¼•æ“

### æ¨¡å¼äºŒï¼šå¤–éƒ¨ç›‘æ§æ ˆ (EXTERNAL)

**é€‚ç”¨åœºæ™¯**: ä¼ä¸šç¯å¢ƒã€å·²æœ‰ç›‘æ§ç³»ç»Ÿã€ç»Ÿä¸€ç›‘æ§ç®¡ç†

**æ”¯æŒçš„å¤–éƒ¨ç³»ç»Ÿ**:
- **Zabbix**: ä¼ä¸šçº§ç›‘æ§è§£å†³æ–¹æ¡ˆ
- **Nagios**: ä¼ ç»Ÿç½‘ç»œç›‘æ§ç³»ç»Ÿ
- **ä¼ä¸šç›‘æ§å¹³å°**: è‡ªç ”æˆ–å•†ä¸šç›‘æ§ç³»ç»Ÿ
- **äº‘ç›‘æ§æœåŠ¡**: é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰äº‘ç›‘æ§

**é…ç½®ç¤ºä¾‹**:
```yaml
monitoring:
  mode: EXTERNAL
  
external:
  endpoints:
    # ä¼ä¸šç›‘æ§å¹³å°
    enterprise_monitor:
      url: "http://monitor.company.com/api"
      enabled: true
      headers:
        Authorization: "Bearer your-token-here"
    
    # Zabbixé›†æˆ
    zabbix:
      url: "http://zabbix.company.com/api_jsonrpc.php"
      enabled: true
      config:
        user: "dbcli"
        password: "password"
```

**é›†æˆæ–¹å¼**:
```java
// å‘Šè­¦æ•°æ®æ ¼å¼
{
  "alerts": [
    {
      "alertId": "ALERT_1694234567890_a1b2c3d4",
      "level": "CRITICAL",
      "systemName": "ç”Ÿäº§ç¯å¢ƒOracleé›†ç¾¤",
      "databaseName": "ORCL",
      "nodeIp": "192.168.1.100",
      "metricDescription": "CPUä½¿ç”¨ç‡",
      "metricValue": "95.5%",
      "alertMessage": "CPUä½¿ç”¨ç‡è¿‡é«˜ (å½“å‰å€¼: 95.5%)",
      "timestamp": "2024-09-10T08:30:15Z"
    }
  ],
  "timestamp": 1694234567890,
  "source": "dbcli"
}
```

**ä¼˜åŠ¿**:
- âœ… æ— ç¼é›†æˆç°æœ‰ç›‘æ§ä½“ç³»
- âœ… ç»Ÿä¸€çš„å‘Šè­¦ç®¡ç†
- âœ… ç¬¦åˆä¼ä¸šITæ²»ç†è¦æ±‚
- âœ… å‡å°‘ç›‘æ§ç³»ç»Ÿç»´æŠ¤æˆæœ¬

### æ¨¡å¼ä¸‰ï¼šæ··åˆæ¨¡å¼ (HYBRID)

**é€‚ç”¨åœºæ™¯**: æ¸è¿›å¼è¿ç§»ã€å¤šç¯å¢ƒéƒ¨ç½²ã€çµæ´»ç›‘æ§ç­–ç•¥

**ç‰¹ç‚¹**:
- åŒæ—¶æ”¯æŒå†…ç½®å’Œå¤–éƒ¨ç›‘æ§æ ˆ
- å¯ä»¥å°†ä¸åŒç±»å‹çš„å‘Šè­¦å‘é€åˆ°ä¸åŒç³»ç»Ÿ
- æ”¯æŒç›‘æ§ç³»ç»Ÿçš„å¹³æ»‘è¿ç§»

**é…ç½®ç¤ºä¾‹**:
```yaml
monitoring:
  mode: HYBRID
  
embedded:
  prometheus:
    url: "http://localhost:9090"
    enabled: true
    
external:
  endpoints:
    enterprise_monitor:
      url: "http://monitor.company.com/api"
      enabled: true
```

## ğŸ“Š ç›‘æ§æ•°æ®æµç¨‹

### 1. æŒ‡æ ‡æ”¶é›†é˜¶æ®µ
```
æ•°æ®åº“æŸ¥è¯¢ â†’ MetricResult â†’ é«˜äº®å€¼æ£€æµ‹ â†’ å‘Šè­¦æ¡ç›®ç”Ÿæˆ
```

### 2. å‘Šè­¦å¤„ç†é˜¶æ®µ
```
AlertItemç”Ÿæˆ â†’ å‘Šè­¦è§„åˆ™åŒ¹é… â†’ çº§åˆ«åˆ¤å®š â†’ æ¶ˆæ¯æ ¼å¼åŒ–
```

### 3. ç›‘æ§é›†æˆé˜¶æ®µ
```
å‘Šè­¦æ¡ç›® â†’ é€‚é…å™¨è½¬æ¢ â†’ ç›‘æ§ç³»ç»ŸAPI â†’ å‘Šè­¦é€šçŸ¥
```

## ğŸ” ç›‘æ§é¢æ¿å’Œå¯è§†åŒ–

### Grafanaä»ªè¡¨æ¿

**æ•°æ®åº“æ¦‚è§ˆé¢æ¿**:
- æ•°æ®åº“è¿æ¥çŠ¶æ€
- å…³é”®æ€§èƒ½æŒ‡æ ‡è¶‹åŠ¿
- èµ„æºä½¿ç”¨ç‡ç»Ÿè®¡
- å‘Šè­¦çŠ¶æ€æ¦‚è§ˆ

**æ€§èƒ½ç›‘æ§é¢æ¿**:
- å“åº”æ—¶é—´åˆ†æ
- ååé‡ç»Ÿè®¡
- æ…¢æŸ¥è¯¢ç›‘æ§
- é”ç­‰å¾…åˆ†æ

**å‘Šè­¦ç®¡ç†é¢æ¿**:
- å®æ—¶å‘Šè­¦åˆ—è¡¨
- å‘Šè­¦è¶‹åŠ¿åˆ†æ
- å‘Šè­¦çº§åˆ«åˆ†å¸ƒ
- ç³»ç»Ÿå¥åº·è¯„åˆ†

### è‡ªå®šä¹‰é¢æ¿é…ç½®
```yaml
dashboards:
  autoCreate: true
  panels:
    - name: "æ•°æ®åº“æ¦‚è§ˆ"
      file: "database-overview.json"
      enabled: true
    - name: "æ€§èƒ½ç›‘æ§"
      file: "performance-monitoring.json"
      enabled: true
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨ç›‘æ§é›†æˆ
```java
// åœ¨DbCliRunnerä¸­é›†æˆç›‘æ§æœåŠ¡
MonitoringIntegrationService monitoringService = new MonitoringIntegrationService();

// å¤„ç†æŒ‡æ ‡ç»“æœ
CompletableFuture<ProcessResult> result = monitoringService.processMetricResults(
    systemName, databaseName, nodeIp, metricResults);
```

### 2. é…ç½®å‘Šè­¦è§„åˆ™
```bash
# ç¼–è¾‘ç›‘æ§é…ç½®æ–‡ä»¶
vim configs/monitoring-config.yml

# æ·»åŠ è‡ªå®šä¹‰å‘Šè­¦è§„åˆ™
alertRules:
  custom_metric:
    critical:
      threshold: 100.0
      message: "è‡ªå®šä¹‰æŒ‡æ ‡å¼‚å¸¸"
```

### 3. éªŒè¯ç›‘æ§åŠŸèƒ½
```bash
# å‘é€æµ‹è¯•å‘Šè­¦
curl -X POST http://localhost:8080/api/monitoring/test-alert

# æŸ¥çœ‹ç›‘æ§çŠ¶æ€
curl http://localhost:8080/api/monitoring/status
```

## ğŸ“ˆ ç›‘æ§æ•ˆæœ

### å‘Šè­¦å“åº”æ—¶é—´
- **æ£€æµ‹å»¶è¿Ÿ**: < 30ç§’
- **å‘Šè­¦ç”Ÿæˆ**: < 5ç§’
- **é€šçŸ¥å‘é€**: < 10ç§’

### ç›‘æ§è¦†ç›–ç‡
- **ç³»ç»ŸæŒ‡æ ‡**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **æ•°æ®åº“æŒ‡æ ‡**: è¿æ¥æ•°ã€å“åº”æ—¶é—´ã€é”ç­‰å¾…ã€è¡¨ç©ºé—´
- **åº”ç”¨æŒ‡æ ‡**: æ‰§è¡ŒæˆåŠŸç‡ã€é”™è¯¯ç‡ã€æ€§èƒ½ç»Ÿè®¡

### å¯é æ€§ä¿è¯
- **æ•…éšœè½¬ç§»**: ç›‘æ§ç³»ç»Ÿæ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢
- **æ•°æ®æŒä¹…åŒ–**: å‘Šè­¦å†å²å’ŒæŒ‡æ ‡æ•°æ®æŒä¹…å­˜å‚¨
- **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥ç›‘æ§ç»„ä»¶çŠ¶æ€

## ğŸ› ï¸ è¿ç»´ç®¡ç†

### ç›‘æ§ç³»ç»Ÿç»´æŠ¤
```bash
# æ£€æŸ¥ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€
java -jar dbcli.jar --monitoring-health

# é‡å¯ç›‘æ§æœåŠ¡
java -jar dbcli.jar --restart-monitoring

# å¯¼å‡ºç›‘æ§é…ç½®
java -jar dbcli.jar --export-monitoring-config
```

### å‘Šè­¦è§„åˆ™ç®¡ç†
```bash
# çƒ­é‡è½½å‘Šè­¦è§„åˆ™
java -jar dbcli.jar --reload-alert-rules

# éªŒè¯å‘Šè­¦è§„åˆ™
java -jar dbcli.jar --validate-alert-rules

# æµ‹è¯•å‘Šè­¦å‘é€
java -jar dbcli.jar --test-alerts
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å‘Šè­¦è§„åˆ™è®¾è®¡
- **åˆ†çº§è®¾ç½®**: åˆç†è®¾ç½®CRITICALå’ŒWARNINGé˜ˆå€¼
- **é¿å…å‘Šè­¦é£æš´**: è®¾ç½®å‘Šè­¦æŠ‘åˆ¶å’Œåˆ†ç»„è§„åˆ™
- **ä¸Šä¸‹æ–‡ä¸°å¯Œ**: æä¾›è¶³å¤Ÿçš„å‘Šè­¦ä¸Šä¸‹æ–‡ä¿¡æ¯

### 2. ç›‘æ§ç³»ç»Ÿé€‰æ‹©
- **å†…ç½®æ¨¡å¼**: é€‚åˆæ–°é¡¹ç›®å’Œç‹¬ç«‹éƒ¨ç½²
- **å¤–éƒ¨æ¨¡å¼**: é€‚åˆä¼ä¸šç¯å¢ƒå’Œç»Ÿä¸€ç®¡ç†
- **æ··åˆæ¨¡å¼**: é€‚åˆæ¸è¿›å¼è¿ç§»å’Œå¤šç¯å¢ƒéƒ¨ç½²

### 3. æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å‘é€å‘Šè­¦å‡å°‘ç½‘ç»œå¼€é”€
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨å¼‚æ­¥æ–¹å¼é¿å…é˜»å¡ä¸»æµç¨‹
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜ç›‘æ§é…ç½®å‡å°‘æ–‡ä»¶è¯»å–

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: å‘Šè­¦æ²¡æœ‰å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ**
A: æ£€æŸ¥ç›‘æ§é…ç½®ã€ç½‘ç»œè¿æ¥å’Œè®¤è¯ä¿¡æ¯

**Q: Grafanaé¢æ¿æ˜¾ç¤ºæ— æ•°æ®**
A: ç¡®è®¤Prometheusæ•°æ®æºé…ç½®å’ŒæŒ‡æ ‡åç§°

**Q: å‘Šè­¦è§„åˆ™ä¸ç”Ÿæ•ˆ**
A: éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼å’Œé‡è½½é…ç½®

### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹ç›‘æ§æ—¥å¿—
tail -f logs/monitoring.log

# æŸ¥çœ‹å‘Šè­¦ç”Ÿæˆæ—¥å¿—
grep "AlertItem" logs/application.log

# æŸ¥çœ‹ç›‘æ§é›†æˆæ—¥å¿—
grep "MonitoringIntegration" logs/application.log
```

---

é€šè¿‡ä»¥ä¸Šç›‘æ§é›†æˆåŠŸèƒ½ï¼ŒDBCLI å®ç°äº†ä»æŒ‡æ ‡æ”¶é›†åˆ°å‘Šè­¦é€šçŸ¥çš„å®Œæ•´ç›‘æ§é“¾è·¯ï¼Œä¸ºæ•°æ®åº“è¿ç»´æä¾›äº†å¼ºå¤§çš„ç›‘æ§æ”¯æŒã€‚