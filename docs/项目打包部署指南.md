# DBCLI é¡¹ç›®æ‰“åŒ…éƒ¨ç½²æŒ‡å—

## ğŸ“¦ é¡¹ç›®æ‰“åŒ…

### ç¯å¢ƒè¦æ±‚
- **JDK**: Java 8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Maven**: 3.6.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **æ“ä½œç³»ç»Ÿ**: Windows/Linux/macOS

### æ‰“åŒ…æ­¥éª¤

#### 1. æ¸…ç†å’Œç¼–è¯‘
```bash
# æ¸…ç†ä¹‹å‰çš„æ„å»º
mvn clean

# ç¼–è¯‘é¡¹ç›®
mvn compile

# è¿è¡Œæµ‹è¯•
mvn test
```

#### 2. ç”Ÿæˆå¯æ‰§è¡ŒJAR
```bash
# æ‰“åŒ…ç”Ÿæˆå¯æ‰§è¡ŒJARæ–‡ä»¶
mvn package

# è·³è¿‡æµ‹è¯•æ‰“åŒ…ï¼ˆç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰
mvn package -DskipTests
```

#### 3. éªŒè¯æ‰“åŒ…ç»“æœ
```bash
# æ£€æŸ¥ç”Ÿæˆçš„JARæ–‡ä»¶
ls -la target/dbcli-1.0.0.jar

# éªŒè¯JARæ–‡ä»¶å®Œæ•´æ€§
java -jar target/dbcli-1.0.0.jar --version
```

### æ‰“åŒ…è„šæœ¬

#### Windows æ‰“åŒ…è„šæœ¬ (build.bat)
```batch
@echo off
echo å¼€å§‹æ„å»ºDBCLIé¡¹ç›®...

echo [1/4] æ¸…ç†é¡¹ç›®...
call mvn clean
if %errorlevel% neq 0 (
    echo æ¸…ç†å¤±è´¥ï¼
    exit /b 1
)

echo [2/4] ç¼–è¯‘é¡¹ç›®...
call mvn compile
if %errorlevel% neq 0 (
    echo ç¼–è¯‘å¤±è´¥ï¼
    exit /b 1
)

echo [3/4] è¿è¡Œæµ‹è¯•...
call mvn test
if %errorlevel% neq 0 (
    echo æµ‹è¯•å¤±è´¥ï¼
    exit /b 1
)

echo [4/4] æ‰“åŒ…é¡¹ç›®...
call mvn package
if %errorlevel% neq 0 (
    echo æ‰“åŒ…å¤±è´¥ï¼
    exit /b 1
)

echo æ„å»ºå®Œæˆï¼JARæ–‡ä»¶ä½ç½®: target\dbcli-1.0.0.jar
```

#### Linux/macOS æ‰“åŒ…è„šæœ¬ (build.sh)
```bash
#!/bin/bash
set -e

echo "å¼€å§‹æ„å»ºDBCLIé¡¹ç›®..."

echo "[1/4] æ¸…ç†é¡¹ç›®..."
mvn clean

echo "[2/4] ç¼–è¯‘é¡¹ç›®..."
mvn compile

echo "[3/4] è¿è¡Œæµ‹è¯•..."
mvn test

echo "[4/4] æ‰“åŒ…é¡¹ç›®..."
mvn package

echo "æ„å»ºå®Œæˆï¼JARæ–‡ä»¶ä½ç½®: target/dbcli-1.0.0.jar"
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### éƒ¨ç½²ç»“æ„
```
dbcli-deployment/
â”œâ”€â”€ dbcli-1.0.0.jar          # ä¸»ç¨‹åºJARæ–‡ä»¶
â”œâ”€â”€ configs/                 # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ oracle-config.yml
â”‚   â”œâ”€â”€ mysql-config.yml
â”‚   â”œâ”€â”€ pg-config.yml
â”‚   â””â”€â”€ dm-config.yml
â”œâ”€â”€ metrics/                 # æŒ‡æ ‡å®šä¹‰ç›®å½•
â”‚   â”œâ”€â”€ oracle-metrics.yml
â”‚   â”œâ”€â”€ mysql-metrics.yml
â”‚   â”œâ”€â”€ pg-metrics.yml
â”‚   â””â”€â”€ dm-metrics.yml
â”œâ”€â”€ lib/                     # æ•°æ®åº“é©±åŠ¨ç›®å½•
â”‚   â”œâ”€â”€ ojdbc8.jar
â”‚   â”œâ”€â”€ mysql-connector-java.jar
â”‚   â”œâ”€â”€ postgresql.jar
â”‚   â””â”€â”€ dm8-jdbc.jar
â”œâ”€â”€ logs/                    # æ—¥å¿—ç›®å½•
â”œâ”€â”€ reports/                 # æŠ¥å‘Šè¾“å‡ºç›®å½•
â””â”€â”€ start.sh                 # å¯åŠ¨è„šæœ¬
```

### éƒ¨ç½²æ­¥éª¤

#### 1. å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ
```bash
# åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /opt/dbcli
cd /opt/dbcli

# åˆ›å»ºå¿…è¦çš„å­ç›®å½•
mkdir -p configs metrics lib logs reports
```

#### 2. å¤åˆ¶æ–‡ä»¶
```bash
# å¤åˆ¶ä¸»ç¨‹åº
cp target/dbcli-1.0.0.jar /opt/dbcli/

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp -r configs/* /opt/dbcli/configs/
cp -r metrics/* /opt/dbcli/metrics/

# å¤åˆ¶æ•°æ®åº“é©±åŠ¨ï¼ˆéœ€è¦å•ç‹¬ä¸‹è½½ï¼‰
cp drivers/*.jar /opt/dbcli/lib/
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡
```bash
# è®¾ç½®JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk

# è®¾ç½®åŠ å¯†å¯†é’¥
export DBCLI_SM4_KEY=your-32-character-encryption-key

# è®¾ç½®JVMå‚æ•°
export JAVA_OPTS="-Xms512m -Xmx2g -XX:+UseG1GC"
```

### å¯åŠ¨è„šæœ¬

#### Linuxå¯åŠ¨è„šæœ¬ (start.sh)
```bash
#!/bin/bash

# è®¾ç½®å·¥ä½œç›®å½•
cd /opt/dbcli

# è®¾ç½®JVMå‚æ•°
JAVA_OPTS="${JAVA_OPTS:--Xms512m -Xmx2g -XX:+UseG1GC}"

# è®¾ç½®åº”ç”¨å‚æ•°
APP_ARGS="-c configs -m metrics -o reports -f both -p 4"

# å¯åŠ¨åº”ç”¨
echo "å¯åŠ¨DBCLIåº”ç”¨..."
java $JAVA_OPTS -jar dbcli-1.0.0.jar $APP_ARGS

echo "DBCLIåº”ç”¨å·²å¯åŠ¨"
```

#### Windowså¯åŠ¨è„šæœ¬ (start.bat)
```batch
@echo off
cd /d %~dp0

set JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC
set APP_ARGS=-c configs -m metrics -o reports -f both -p 4

echo å¯åŠ¨DBCLIåº”ç”¨...
java %JAVA_OPTS% -jar dbcli-1.0.0.jar %APP_ARGS%

echo DBCLIåº”ç”¨å·²å¯åŠ¨
pause
```

## ğŸ³ Dockeréƒ¨ç½²

### Dockerfile
```dockerfile
FROM openjdk:8-jre-alpine

LABEL maintainer="dbcli-team"
LABEL version="1.0.0"

# å®‰è£…å¿…è¦å·¥å…·
RUN apk add --no-cache curl bash tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN addgroup -g 1000 dbcli && \
    adduser -D -s /bin/bash -u 1000 -G dbcli dbcli

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app
RUN chown -R dbcli:dbcli /app

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER dbcli

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY --chown=dbcli:dbcli target/dbcli-1.0.0.jar app.jar
COPY --chown=dbcli:dbcli configs/ configs/
COPY --chown=dbcli:dbcli metrics/ metrics/
COPY --chown=dbcli:dbcli lib/ lib/

# åˆ›å»ºæ—¥å¿—å’ŒæŠ¥å‘Šç›®å½•
RUN mkdir -p logs reports

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/api/status || exit 1

# JVMä¼˜åŒ–å‚æ•°
ENV JAVA_OPTS="-Xms512m -Xmx1g -XX:+UseG1GC -XX:+UseStringDeduplication"

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar \"$@\"", "--"]
CMD ["-c", "configs", "-m", "metrics", "-o", "reports", "-f", "both"]
```

### Dockeræ„å»ºå’Œè¿è¡Œ
```bash
# æ„å»ºDockeré•œåƒ
docker build -t dbcli:1.0.0 .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name dbcli \
  -p 8080:8080 \
  -e DBCLI_SM4_KEY=your-encryption-key \
  -v $(pwd)/configs:/app/configs:ro \
  -v $(pwd)/reports:/app/reports \
  -v $(pwd)/logs:/app/logs \
  dbcli:1.0.0
```

### Docker Compose
```yaml
version: '3.8'

services:
  dbcli:
    build: .
    image: dbcli:1.0.0
    container_name: dbcli
    ports:
      - "8080:8080"
    environment:
      - DBCLI_SM4_KEY=${DBCLI_SM4_KEY}
      - JAVA_OPTS=-Xms512m -Xmx1g -XX:+UseG1GC
    volumes:
      - ./configs:/app/configs:ro
      - ./metrics:/app/metrics:ro
      - ./reports:/app/reports
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®
| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|--------|------|--------|------|
| DBCLI_SM4_KEY | SM4åŠ å¯†å¯†é’¥ | å†…ç½®é»˜è®¤å€¼ | 32å­—ç¬¦å¯†é’¥ |
| JAVA_OPTS | JVMå‚æ•° | -Xms512m -Xmx2g | æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ |
| DBCLI_LOG_LEVEL | æ—¥å¿—çº§åˆ« | INFO | DEBUG/INFO/WARN/ERROR |
| DBCLI_WEB_PORT | Webç«¯å£ | 8080 | 8080-65535 |

### ç³»ç»Ÿè¦æ±‚
- **CPU**: 2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Šï¼ˆæ¨è8GBï¼‰
- **ç£ç›˜**: 10GBä»¥ä¸Šå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: èƒ½å¤Ÿè®¿é—®ç›®æ ‡æ•°æ®åº“

## ğŸ”§ è¿ç»´ç®¡ç†

### å¯åŠ¨å’Œåœæ­¢
```bash
# å¯åŠ¨æœåŠ¡
./start.sh

# åœæ­¢æœåŠ¡ï¼ˆCtrl+Cæˆ–å‘é€SIGTERMä¿¡å·ï¼‰
kill -TERM <pid>

# é‡å¯æœåŠ¡
./restart.sh
```

### æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/dbcli_INFO.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/dbcli_ERROR.log

# æ—¥å¿—è½®è½¬ï¼ˆè‡ªåŠ¨è¿›è¡Œï¼‰
# æ—¥å¿—æ–‡ä»¶ä¼šè‡ªåŠ¨æŒ‰å¤§å°å’Œæ—¶é—´è½®è½¬
```

### ç›‘æ§æ£€æŸ¥
```bash
# æ£€æŸ¥åº”ç”¨çŠ¶æ€
curl http://localhost:8080/api/status

# æ£€æŸ¥ç³»ç»ŸæŒ‡æ ‡
curl http://localhost:8080/api/metrics

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep dbcli
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# æ£€æŸ¥JARæ–‡ä»¶å®Œæ•´æ€§
java -jar dbcli-1.0.0.jar --version

# æ£€æŸ¥é…ç½®æ–‡ä»¶
ls -la configs/
```

#### 2. è¿æ¥æ•°æ®åº“å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
telnet <db_host> <db_port>

# æ£€æŸ¥æ•°æ®åº“é©±åŠ¨
ls -la lib/

# æ£€æŸ¥é…ç½®æ–‡ä»¶åŠ å¯†
# ç¡®ä¿DBCLI_SM4_KEYç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½®
```

#### 3. å†…å­˜ä¸è¶³
```bash
# è°ƒæ•´JVMå†…å­˜å‚æ•°
export JAVA_OPTS="-Xms1g -Xmx4g -XX:+UseG1GC"

# ç›‘æ§å†…å­˜ä½¿ç”¨
jstat -gc <pid>
```

### æ€§èƒ½è°ƒä¼˜
```bash
# è°ƒæ•´çº¿ç¨‹æ± å¤§å°
java -jar dbcli-1.0.0.jar -p 8

# è°ƒæ•´JVMå‚æ•°
export JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# å¯ç”¨JVMç›‘æ§
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025å¹´9æœˆ5æ—¥