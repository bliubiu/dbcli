# DBCLI 项目打包部署指南

## 📦 项目打包

### 环境要求
- **JDK**: Java 8 或更高版本
- **Maven**: 3.6.0 或更高版本
- **操作系统**: Windows/Linux/macOS

### 打包步骤

#### 1. 清理和编译
```bash
# 清理之前的构建
mvn clean

# 编译项目
mvn compile

# 运行测试
mvn test
```

#### 2. 生成可执行JAR
```bash
# 打包生成可执行JAR文件
mvn package

# 跳过测试打包（生产环境不推荐）
mvn package -DskipTests
```

#### 3. 验证打包结果
```bash
# 检查生成的JAR文件
ls -la target/dbcli-1.0.0.jar

# 验证JAR文件完整性
java -jar target/dbcli-1.0.0.jar --version
```

### 打包脚本

#### Windows 打包脚本 (build.bat)
```batch
@echo off
echo 开始构建DBCLI项目...

echo [1/4] 清理项目...
call mvn clean
if %errorlevel% neq 0 (
    echo 清理失败！
    exit /b 1
)

echo [2/4] 编译项目...
call mvn compile
if %errorlevel% neq 0 (
    echo 编译失败！
    exit /b 1
)

echo [3/4] 运行测试...
call mvn test
if %errorlevel% neq 0 (
    echo 测试失败！
    exit /b 1
)

echo [4/4] 打包项目...
call mvn package
if %errorlevel% neq 0 (
    echo 打包失败！
    exit /b 1
)

echo 构建完成！JAR文件位置: target\dbcli-1.0.0.jar
```

#### Linux/macOS 打包脚本 (build.sh)
```bash
#!/bin/bash
set -e

echo "开始构建DBCLI项目..."

echo "[1/4] 清理项目..."
mvn clean

echo "[2/4] 编译项目..."
mvn compile

echo "[3/4] 运行测试..."
mvn test

echo "[4/4] 打包项目..."
mvn package

echo "构建完成！JAR文件位置: target/dbcli-1.0.0.jar"
```

## 🚀 部署指南

### 部署结构
```
dbcli-deployment/
├── dbcli-1.0.0.jar          # 主程序JAR文件
├── configs/                 # 配置文件目录
│   ├── oracle-config.yml
│   ├── mysql-config.yml
│   ├── pg-config.yml
│   └── dm-config.yml
├── metrics/                 # 指标定义目录
│   ├── oracle-metrics.yml
│   ├── mysql-metrics.yml
│   ├── pg-metrics.yml
│   └── dm-metrics.yml
├── lib/                     # 数据库驱动目录
│   ├── ojdbc8.jar
│   ├── mysql-connector-java.jar
│   ├── postgresql.jar
│   └── dm8-jdbc.jar
├── logs/                    # 日志目录
├── reports/                 # 报告输出目录
└── start.sh                 # 启动脚本
```

### 部署步骤

#### 1. 准备部署环境
```bash
# 创建部署目录
mkdir -p /opt/dbcli
cd /opt/dbcli

# 创建必要的子目录
mkdir -p configs metrics lib logs reports
```

#### 2. 复制文件
```bash
# 复制主程序
cp target/dbcli-1.0.0.jar /opt/dbcli/

# 复制配置文件
cp -r configs/* /opt/dbcli/configs/
cp -r metrics/* /opt/dbcli/metrics/

# 复制数据库驱动（需要单独下载）
cp drivers/*.jar /opt/dbcli/lib/
```

#### 3. 配置环境变量
```bash
# 设置JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk

# 设置加密密钥
export DBCLI_SM4_KEY=your-32-character-encryption-key

# 设置JVM参数
export JAVA_OPTS="-Xms512m -Xmx2g -XX:+UseG1GC"
```

### 启动脚本

#### Linux启动脚本 (start.sh)
```bash
#!/bin/bash

# 设置工作目录
cd /opt/dbcli

# 设置JVM参数
JAVA_OPTS="${JAVA_OPTS:--Xms512m -Xmx2g -XX:+UseG1GC}"

# 设置应用参数
APP_ARGS="-c configs -m metrics -o reports -f both -p 4"

# 启动应用
echo "启动DBCLI应用..."
java $JAVA_OPTS -jar dbcli-1.0.0.jar $APP_ARGS

echo "DBCLI应用已启动"
```

#### Windows启动脚本 (start.bat)
```batch
@echo off
cd /d %~dp0

set JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC
set APP_ARGS=-c configs -m metrics -o reports -f both -p 4

echo 启动DBCLI应用...
java %JAVA_OPTS% -jar dbcli-1.0.0.jar %APP_ARGS%

echo DBCLI应用已启动
pause
```

## 🐳 Docker部署

### Dockerfile
```dockerfile
FROM openjdk:8-jre-alpine

LABEL maintainer="dbcli-team"
LABEL version="1.0.0"

# 安装必要工具
RUN apk add --no-cache curl bash tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 创建应用用户
RUN addgroup -g 1000 dbcli && \
    adduser -D -s /bin/bash -u 1000 -G dbcli dbcli

# 创建应用目录
WORKDIR /app
RUN chown -R dbcli:dbcli /app

# 切换到应用用户
USER dbcli

# 复制应用文件
COPY --chown=dbcli:dbcli target/dbcli-1.0.0.jar app.jar
COPY --chown=dbcli:dbcli configs/ configs/
COPY --chown=dbcli:dbcli metrics/ metrics/
COPY --chown=dbcli:dbcli lib/ lib/

# 创建日志和报告目录
RUN mkdir -p logs reports

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/api/status || exit 1

# JVM优化参数
ENV JAVA_OPTS="-Xms512m -Xmx1g -XX:+UseG1GC -XX:+UseStringDeduplication"

# 启动应用
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar \"$@\"", "--"]
CMD ["-c", "configs", "-m", "metrics", "-o", "reports", "-f", "both"]
```

### Docker构建和运行
```bash
# 构建Docker镜像
docker build -t dbcli:1.0.0 .

# 运行容器
docker run -d \
  --name dbcli \
  -p 8080:8080 \
  -e DBCLI_SM4_KEY=your-encryption-key \
  -v $(pwd)/configs:/app/configs:ro \
  -v $(pwd)/reports:/app/reports \
  -v $(pwd)/logs:/app/logs \
  dbcli:1.0.0
```

### Docker Compose
```yaml
version: '3.8'

services:
  dbcli:
    build: .
    image: dbcli:1.0.0
    container_name: dbcli
    ports:
      - "8080:8080"
    environment:
      - DBCLI_SM4_KEY=${DBCLI_SM4_KEY}
      - JAVA_OPTS=-Xms512m -Xmx1g -XX:+UseG1GC
    volumes:
      - ./configs:/app/configs:ro
      - ./metrics:/app/metrics:ro
      - ./reports:/app/reports
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
```

## ⚙️ 配置说明

### 环境变量配置
| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| DBCLI_SM4_KEY | SM4加密密钥 | 内置默认值 | 32字符密钥 |
| JAVA_OPTS | JVM参数 | -Xms512m -Xmx2g | 根据服务器配置调整 |
| DBCLI_LOG_LEVEL | 日志级别 | INFO | DEBUG/INFO/WARN/ERROR |
| DBCLI_WEB_PORT | Web端口 | 8080 | 8080-65535 |

### 系统要求
- **CPU**: 2核心以上
- **内存**: 4GB以上（推荐8GB）
- **磁盘**: 10GB以上可用空间
- **网络**: 能够访问目标数据库

## 🔧 运维管理

### 启动和停止
```bash
# 启动服务
./start.sh

# 停止服务（Ctrl+C或发送SIGTERM信号）
kill -TERM <pid>

# 重启服务
./restart.sh
```

### 日志管理
```bash
# 查看实时日志
tail -f logs/dbcli_INFO.log

# 查看错误日志
tail -f logs/dbcli_ERROR.log

# 日志轮转（自动进行）
# 日志文件会自动按大小和时间轮转
```

### 监控检查
```bash
# 检查应用状态
curl http://localhost:8080/api/status

# 检查系统指标
curl http://localhost:8080/api/metrics

# 检查进程状态
ps aux | grep dbcli
```

## 🚨 故障排除

### 常见问题

#### 1. 启动失败
```bash
# 检查Java版本
java -version

# 检查JAR文件完整性
java -jar dbcli-1.0.0.jar --version

# 检查配置文件
ls -la configs/
```

#### 2. 连接数据库失败
```bash
# 检查网络连通性
telnet <db_host> <db_port>

# 检查数据库驱动
ls -la lib/

# 检查配置文件加密
# 确保DBCLI_SM4_KEY环境变量正确设置
```

#### 3. 内存不足
```bash
# 调整JVM内存参数
export JAVA_OPTS="-Xms1g -Xmx4g -XX:+UseG1GC"

# 监控内存使用
jstat -gc <pid>
```

### 性能调优
```bash
# 调整线程池大小
java -jar dbcli-1.0.0.jar -p 8

# 调整JVM参数
export JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# 启用JVM监控
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
```

---

**文档版本**: v1.0  
**更新时间**: 2025年9月5日