package com.dbcli.web;

import com.dbcli.config.AppConfig;
import com.dbcli.config.ConfigLoader;
import com.dbcli.core.DbCliRunner;
import com.dbcli.model.DatabaseConfig;
import com.dbcli.service.EncryptionService;
import com.dbcli.service.FastConnectionTestService;
import com.dbcli.database.ConnectionFactory;
import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.OutputStream;
import java.io.RandomAccessFile;
import java.net.InetSocketAddress;
import java.nio.charset.StandardCharsets;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.concurrent.Executors;
import java.util.stream.Collectors;

/**
 * å¢å¼ºç‰ˆWebç®¡ç†æœåŠ¡å™¨
 * åŒ…å«å®Œæ•´çš„æ•°æ®åº“è¿æ¥æµ‹è¯•ã€é…ç½®åŠ å¯†ã€æŠ¥å‘Šç”Ÿæˆå’Œå®æ—¶æ—¥å¿—åŠŸèƒ½
 */
public class EnhancedWebServer {
    private static final Logger logger = LoggerFactory.getLogger(EnhancedWebServer.class);
    
    private HttpServer server;
    private final int port;
    private final AppConfig config;
    private volatile boolean running = false;
    
    // è¿æ¥æµ‹è¯•é¢‘ç‡é™åˆ¶ - 10åˆ†é’Ÿå†…åªèƒ½æ‰§è¡Œä¸€æ¬¡
    private static final long CONNECTION_TEST_COOLDOWN = 10 * 60 * 1000; // 10åˆ†é’Ÿ
    private long lastConnectionTestTime = 0;
    
    public EnhancedWebServer(AppConfig config) {
        this.port = config.getWebPort() > 0 ? config.getWebPort() : 8080;
        this.config = config;
    }
    
    public void start() throws IOException {
        if (running) {
            logger.warn("Webç®¡ç†æœåŠ¡å™¨å·²ç»åœ¨è¿è¡Œä¸­");
            return;
        }
        
        server = HttpServer.create(new InetSocketAddress(port), 0);
        
        // æ³¨å†Œå¤„ç†å™¨
        server.createContext("/", new DashboardHandler());
        server.createContext("/api/connection-test", new ConnectionTestHandler());
        server.createContext("/api/encrypt-config", new EncryptConfigHandler());
        server.createContext("/api/generate-report", new ReportGenerationHandler());
        server.createContext("/api/logs", new RealTimeLogsHandler());
        server.createContext("/api/status", new StatusHandler());
        server.createContext("/api/config", new ConfigManagementHandler());
        server.createContext("/reports/", new StaticFileHandler());
        
        server.setExecutor(Executors.newFixedThreadPool(4));
        server.start();
        
        running = true;
        logger.info("å¢å¼ºç‰ˆWebç®¡ç†æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œè®¿é—®åœ°å€: http://localhost:{}", port);
    }
    
    public void stop() {
        if (server != null && running) {
            server.stop(2);
            running = false;
            logger.info("Webç®¡ç†æœåŠ¡å™¨å·²åœæ­¢");
        }
    }
    
    public boolean isRunning() {
        return running;
    }
    
    public int getPort() {
        return port;
    }
    
    public void waitForShutdown() {
        while (running) {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
    
    /**
     * ä»ªè¡¨æ¿å¤„ç†å™¨ - æä¾›å®Œæ•´çš„Webç®¡ç†ç•Œé¢
     */
    private class DashboardHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            String response = generateEnhancedDashboardHtml();
            sendResponse(exchange, 200, response, "text/html");
        }
        
        private String generateEnhancedDashboardHtml() {
            return "<!DOCTYPE html>\n" +
                "<html lang=\"zh-CN\">\n" +
                "<head>\n" +
                "    <meta charset=\"UTF-8\">\n" +
                "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n" +
                "    <title>DBCLI å¢å¼ºç‰ˆç®¡ç†æ§åˆ¶å°</title>\n" +
                "    <style>\n" +
                "        * { margin: 0; padding: 0; box-sizing: border-box; }\n" +
                "        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }\n" +
                "        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n" +
                "        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }\n" +
                "        .header p { font-size: 1.1rem; opacity: 0.9; }\n" +
                "        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }\n" +
                "        .card { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border: 1px solid #e1e8ed; }\n" +
                "        .card h3 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.4rem; display: flex; align-items: center; }\n" +
                "        .card h3::before { content: attr(data-icon); margin-right: 0.5rem; font-size: 1.6rem; }\n" +
                "        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }\n" +
                "        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; margin: 0.5rem; font-size: 1rem; transition: all 0.3s ease; }\n" +
                "        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }\n" +
                "        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }\n" +
                "        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }\n" +
                "        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }\n" +
                "        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }\n" +
                "        .btn-secondary { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }\n" +
                "        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }\n" +
                "        .status-online { background: #27ae60; }\n" +
                "        .status-offline { background: #e74c3c; }\n" +
                "        .status-warning { background: #f39c12; }\n" +
                "        .log-container { background: #2c3e50; color: #ecf0f1; padding: 1.5rem; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; max-height: 400px; overflow-y: auto; font-size: 0.9rem; line-height: 1.4; }\n" +
                "        .log-line { margin-bottom: 4px; white-space: pre-wrap; }\n" +
                "        .log-error { color: #e74c3c; }\n" +
                "        .log-warn { color: #f39c12; }\n" +
                "        .log-info { color: #3498db; }\n" +
                "        .log-success { color: #27ae60; }\n" +
                "        .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }\n" +
                "        .metric-card { text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; }\n" +
                "        .metric-value { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; }\n" +
                "        .metric-label { font-size: 1rem; opacity: 0.9; }\n" +
                "        .progress-bar { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin: 1rem 0; }\n" +
                "        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }\n" +
                "        .alert { padding: 1rem; border-radius: 8px; margin: 1rem 0; }\n" +
                "        .alert-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }\n" +
                "        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }\n" +
                "        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }\n" +
                "        .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }\n" +
                "        .loading { display: none; }\n" +
                "        .loading.show { display: inline-block; }\n" +
                "        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }\n" +
                "        @keyframes spin { to { transform: rotate(360deg); } }\n" +
                "        .cooldown-info { background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #ffc107; }\n" +
                "        .config-list { margin-top: 1rem; }\n" +
                "        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border: 1px solid #eee; border-radius: 6px; margin-bottom: 0.5rem; }\n" +
                "        .config-item:hover { background: #f8f9fa; }\n" +
                "        .config-actions { display: flex; gap: 0.5rem; }\n" +
                "        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }\n" +
                "        .modal-content { background-color: white; margin: 5% auto; padding: 2rem; border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }\n" +
                "        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }\n" +
                "        .close:hover { color: black; }\n" +
                "        .form-group { margin-bottom: 1rem; }\n" +
                "        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }\n" +
                "        .form-group textarea { width: 100%; min-height: 300px; font-family: 'Consolas', 'Monaco', monospace; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }\n" +
                "        .tabs { display: flex; margin-bottom: 1rem; border-bottom: 1px solid #eee; }\n" +
                "        .tab { padding: 1rem 2rem; cursor: pointer; border-bottom: 3px solid transparent; }\n" +
                "        .tab.active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: bold; }\n" +
                "        .tab-content { display: none; }\n" +
                "        .tab-content.active { display: block; }\n" +
                "    </style>\n" +
                "</head>\n" +
                "<body>\n" +
                "    <div class=\"header\">\n" +
                "        <h1>ğŸš€ DBCLI å¢å¼ºç‰ˆç®¡ç†æ§åˆ¶å°</h1>\n" +
                "        <p>æ•°æ®åº“è¿æ¥æ€§èƒ½æµ‹è¯•å·¥å…· - å®Œæ•´åŠŸèƒ½Webç®¡ç†ç•Œé¢</p>\n" +
                "    </div>\n" +
                "    \n" +
                "    <div class=\"container\">\n" +
                "        <div class=\"tabs\">\n" +
                "            <div class=\"tab active\" data-tab=\"dashboard\">ä»ªè¡¨æ¿</div>\n" +
                "            <div class=\"tab\" data-tab=\"config\">é…ç½®ç®¡ç†</div>\n" +
                "        </div>\n" +
                "        \n" +
                "        <div id=\"dashboard-tab\" class=\"tab-content active\">\n" +
                "            <div class=\"grid\">\n" +
                "                <div class=\"card\">\n" +
                "                    <h3 data-icon=\"ğŸ“Š\">ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>\n" +
                "                    <div class=\"metric-card\">\n" +
                "                        <div class=\"metric-value\" id=\"systemStatus\">\n" +
                "                            <span class=\"status-indicator status-online\"></span>è¿è¡Œä¸­\n" +
                "                        </div>\n" +
                "                        <div class=\"metric-label\">ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</div>\n" +
                "                    </div>\n" +
                "                    <div class=\"progress-bar\">\n" +
                "                        <div class=\"progress-fill\" style=\"width: 85%\"></div>\n" +
                "                    </div>\n" +
                "                    <p>ç³»ç»Ÿå¥åº·åº¦: 85%</p>\n" +
                "                </div>\n" +
                "                \n" +
                "                <div class=\"card\">\n" +
                "                    <h3 data-icon=\"ğŸ”—\">æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>\n" +
                "                    <div class=\"alert alert-info\">\n" +
                "                        <strong>åŠŸèƒ½è¯´æ˜:</strong> æµ‹è¯•æ‰€æœ‰é…ç½®çš„æ•°æ®åº“è¿æ¥ï¼Œè‡ªåŠ¨é‡ç½®é»‘åå•ï¼Œæ”¯æŒé¢‘ç‡é™åˆ¶ä¿æŠ¤ã€‚\n" +
                "                    </div>\n" +
                "                    <div id=\"connectionTestResult\"></div>\n" +
                "                    <div class=\"button-group\">\n" +
                "                        <button class=\"btn btn-warning\" onclick=\"testDatabaseConnections()\" id=\"testConnectionBtn\">\n" +
                "                            <span class=\"loading\" id=\"testLoading\"><span class=\"spinner\"></span></span>\n" +
                "                            ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥\n" +
                "                        </button>\n" +
                "                    </div>\n" +
                "                    <div id=\"cooldownInfo\" class=\"cooldown-info\" style=\"display: none;\"></div>\n" +
                "                </div>\n" +
                "            </div>\n" +
                "            \n" +
                "            <div class=\"grid\">\n" +
                "                <div class=\"card\">\n" +
                "                    <h3 data-icon=\"ğŸ”\">é…ç½®æ–‡ä»¶åŠ å¯†</h3>\n" +
                "                    <div class=\"alert alert-info\">\n" +
                "                        <strong>å®‰å…¨æç¤º:</strong> ä½¿ç”¨SM4ç®—æ³•åŠ å¯†æ•°æ®åº“é…ç½®æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼Œç¡®ä¿å¯†ç å®‰å…¨ã€‚\n" +
                "                    </div>\n" +
                "                    <div id=\"encryptResult\"></div>\n" +
                "                    <div class=\"button-group\">\n" +
                "                        <button class=\"btn btn-success\" onclick=\"encryptConfigurations()\" id=\"encryptBtn\">\n" +
                "                            <span class=\"loading\" id=\"encryptLoading\"><span class=\"spinner\"></span></span>\n" +
                "                            ğŸ”’ åŠ å¯†é…ç½®æ–‡ä»¶\n" +
                "                        </button>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                \n" +
                "                <div class=\"card\">\n" +
                "                    <h3 data-icon=\"ğŸ“ˆ\">æŠ¥å‘Šç”Ÿæˆ</h3>\n" +
                "                    <div class=\"alert alert-info\">\n" +
                "                        <strong>æŠ¥å‘Šç±»å‹:</strong> æ”¯æŒExcelå’ŒHTMLæ ¼å¼æŠ¥å‘Šï¼ŒåŒ…å«è¯¦ç»†çš„æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡å’Œåˆ†æã€‚\n" +
                "                    </div>\n" +
                "                    <div id=\"reportResult\"></div>\n" +
                "                    <div class=\"button-group\">\n" +
                "                        <button class=\"btn btn-info\" onclick=\"generateReport('excel')\" id=\"excelBtn\">\n" +
                "                            <span class=\"loading\" id=\"excelLoading\"><span class=\"spinner\"></span></span>\n" +
                "                            ğŸ“Š ç”ŸæˆExcelæŠ¥å‘Š\n" +
                "                        </button>\n" +
                "                        <button class=\"btn btn-info\" onclick=\"generateReport('html')\" id=\"htmlBtn\">\n" +
                "                            <span class=\"loading\" id=\"htmlLoading\"><span class=\"spinner\"></span></span>\n" +
                "                            ğŸŒ ç”ŸæˆHTMLæŠ¥å‘Š\n" +
                "                        </button>\n" +
                "                        <button class=\"btn\" onclick=\"generateReport('both')\" id=\"bothBtn\">\n" +
                "                            <span class=\"loading\" id=\"bothLoading\"><span class=\"spinner\"></span></span>\n" +
                "                            ğŸ“‹ ç”Ÿæˆå…¨éƒ¨æŠ¥å‘Š\n" +
                "                        </button>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "            </div>\n" +
                "            \n" +
                "            <div class=\"card\">\n" +
                "                <h3 data-icon=\"ğŸ“\">å®æ—¶æ—¥å¿—ç›‘æ§</h3>\n" +
                "                <div class=\"alert alert-info\">\n" +
                "                    <strong>æ—¥å¿—è¯´æ˜:</strong> å®æ—¶æ˜¾ç¤ºç³»ç»Ÿè¿è¡Œæ—¥å¿—ï¼Œè‡ªåŠ¨åˆ·æ–°ï¼Œæ”¯æŒå¤šç§æ—¥å¿—çº§åˆ«æ˜¾ç¤ºã€‚\n" +
                "                </div>\n" +
                "                <div class=\"log-container\" id=\"logContainer\">\n" +
                "                    <div class=\"log-line log-info\">[INFO] Webç®¡ç†ç•Œé¢å·²å¯åŠ¨</div>\n" +
                "                    <div class=\"log-line log-info\">[INFO] é…ç½®çƒ­é‡è½½åŠŸèƒ½å·²å¯ç”¨</div>\n" +
                "                    <div class=\"log-line log-success\">[SUCCESS] ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>\n" +
                "                </div>\n" +
                "                <div class=\"button-group\">\n" +
                "                    <button class=\"btn\" onclick=\"refreshLogs()\">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>\n" +
                "                    <button class=\"btn\" onclick=\"clearLogs()\">ğŸ—‘ï¸ æ¸…ç©ºæ˜¾ç¤º</button>\n" +
                "                </div>\n" +
                "            </div>\n" +
                "        </div>\n" +
                "        \n" +
                "        <div id=\"config-tab\" class=\"tab-content\">\n" +
                "            <div class=\"card\">\n" +
                "                <h3 data-icon=\"âš™ï¸\">æ•°æ®åº“é…ç½®ç®¡ç†</h3>\n" +
                "                <div class=\"alert alert-info\">\n" +
                "                    <strong>åŠŸèƒ½è¯´æ˜:</strong> æŸ¥çœ‹ã€ç¼–è¾‘å’Œç®¡ç†æ•°æ®åº“é…ç½®æ–‡ä»¶ï¼Œæ”¯æŒYAMLæ ¼å¼ã€‚\n" +
                "                </div>\n" +
                "                <div id=\"configResult\"></div>\n" +
                "                <div class=\"button-group\">\n" +
                "                    <button class=\"btn btn-info\" onclick=\"loadConfigList()\">ğŸ”„ åˆ·æ–°é…ç½®åˆ—è¡¨</button>\n" +
                "                    <button class=\"btn btn-success\" onclick=\"createNewConfig()\">â• æ–°å»ºé…ç½®æ–‡ä»¶</button>\n" +
                "                </div>\n" +
                "                <div class=\"config-list\" id=\"configList\">\n" +
                "                    <!-- é…ç½®æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->\n" +
                "                </div>\n" +
                "            </div>\n" +
                "        </div>\n" +
                "    </div>\n" +
                "    \n" +
                "    <!-- é…ç½®ç¼–è¾‘æ¨¡æ€æ¡† -->\n" +
                "    <div id=\"configModal\" class=\"modal\">\n" +
                "        <div class=\"modal-content\">\n" +
                "            <span class=\"close\" onclick=\"closeConfigModal()\">&times;</span>\n" +
                "            <h2 id=\"modalTitle\">ç¼–è¾‘é…ç½®æ–‡ä»¶</h2>\n" +
                "            <form id=\"configForm\">\n" +
                "                <input type=\"hidden\" id=\"configFileName\">\n" +
                "                <div class=\"form-group\">\n" +
                "                    <label for=\"configContent\">é…ç½®å†…å®¹ (YAMLæ ¼å¼):</label>\n" +
                "                    <textarea id=\"configContent\" placeholder=\"åœ¨æ­¤è¾“å…¥YAMLæ ¼å¼çš„é…ç½®å†…å®¹...\"></textarea>\n" +
                "                </div>\n" +
                "                <div class=\"button-group\">\n" +
                "                    <button type=\"button\" class=\"btn btn-success\" onclick=\"saveConfig()\">ğŸ’¾ ä¿å­˜é…ç½®</button>\n" +
                "                    <button type=\"button\" class=\"btn btn-secondary\" onclick=\"closeConfigModal()\">âŒ å–æ¶ˆ</button>\n" +
                "                    <button type=\"button\" class=\"btn btn-warning\" onclick=\"deleteConfig()\" id=\"deleteConfigBtn\" style=\"display: none;\">ğŸ—‘ï¸ åˆ é™¤é…ç½®</button>\n" +
                "                </div>\n" +
                "            </form>\n" +
                "        </div>\n" +
                "    </div>\n" +
                "    \n" +
                "    <script>\n" +
                "        let logRefreshInterval;\n" +
                "        let lastConnectionTestTime = 0;\n" +
                "        const CONNECTION_TEST_COOLDOWN = 10 * 60 * 1000; // 10åˆ†é’Ÿ\n" +
                "        \n" +
                "        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨å®šæ—¶åˆ·æ–°\n" +
                "        document.addEventListener('DOMContentLoaded', function() {\n" +
                "            refreshLogs();\n" +
                "            startLogRefresh();\n" +
                "            \n" +
                "            // æ·»åŠ æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½\n" +
                "            document.querySelectorAll('.tab').forEach(tab => {\n" +
                "                tab.addEventListener('click', function() {\n" +
                "                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€\n" +
                "                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));\n" +
                "                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));\n" +
                "                    \n" +
                "                    // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ\n" +
                "                    this.classList.add('active');\n" +
                "                    const tabName = this.getAttribute('data-tab');\n" +
                "                    document.getElementById(tabName + '-tab').classList.add('active');\n" +
                "                    \n" +
                "                    // å¦‚æœæ˜¯é…ç½®ç®¡ç†æ ‡ç­¾é¡µï¼ŒåŠ è½½é…ç½®åˆ—è¡¨\n" +
                "                    if (tabName === 'config') {\n" +
                "                        loadConfigList();\n" +
                "                    }\n" +
                "                });\n" +
                "            });\n" +
                "        });\n" +
                "        \n" +
                "        function startLogRefresh() {\n" +
                "            logRefreshInterval = setInterval(refreshLogs, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡\n" +
                "        }\n" +
                "        \n" +
                "        function stopLogRefresh() {\n" +
                "            if (logRefreshInterval) {\n" +
                "                clearInterval(logRefreshInterval);\n" +
                "            }\n" +
                "        }\n" +
                "        \n" +
                "        function refreshLogs() {\n" +
                "            fetch('/api/logs')\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    const logContainer = document.getElementById('logContainer');\n" +
                "                    if (data.logs && data.logs.length > 0) {\n" +
                "                        logContainer.innerHTML = '';\n" +
                "                        data.logs.forEach(log => {\n" +
                "                            const logElement = document.createElement('div');\n" +
                "                            logElement.className = 'log-line ' + getLogClass(log);\n" +
                "                            logElement.textContent = log;\n" +
                "                            logContainer.appendChild(logElement);\n" +
                "                        });\n" +
                "                        logContainer.scrollTop = logContainer.scrollHeight;\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    console.warn('åˆ·æ–°æ—¥å¿—å¤±è´¥:', err);\n" +
                "                    // é™é»˜å¤„ç†æ—¥å¿—æœåŠ¡å¼‚å¸¸ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function getLogClass(logText) {\n" +
                "            if (logText.includes('[ERROR]') || logText.includes('å¤±è´¥') || logText.includes('å¼‚å¸¸')) {\n" +
                "                return 'log-error';\n" +
                "            } else if (logText.includes('[WARN]') || logText.includes('è­¦å‘Š')) {\n" +
                "                return 'log-warn';\n" +
                "            } else if (logText.includes('[SUCCESS]') || logText.includes('æˆåŠŸ')) {\n" +
                "                return 'log-success';\n" +
                "            } else {\n" +
                "                return 'log-info';\n" +
                "            }\n" +
                "        }\n" +
                "        \n" +
                "        function clearLogs() {\n" +
                "            document.getElementById('logContainer').innerHTML = '<div class=\"log-line log-info\">[INFO] æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º</div>';\n" +
                "        }\n" +
                "        \n" +
                "        function testDatabaseConnections() {\n" +
                "            const now = Date.now();\n" +
                "            const timeSinceLastTest = now - lastConnectionTestTime;\n" +
                "            \n" +
                "            if (timeSinceLastTest < CONNECTION_TEST_COOLDOWN) {\n" +
                "                const remainingTime = Math.ceil((CONNECTION_TEST_COOLDOWN - timeSinceLastTest) / 1000 / 60);\n" +
                "                showCooldownMessage(remainingTime);\n" +
                "                return;\n" +
                "            }\n" +
                "            \n" +
                "            const btn = document.getElementById('testConnectionBtn');\n" +
                "            const loading = document.getElementById('testLoading');\n" +
                "            const resultDiv = document.getElementById('connectionTestResult');\n" +
                "            \n" +
                "            btn.disabled = true;\n" +
                "            loading.classList.add('show');\n" +
                "            resultDiv.innerHTML = '<div class=\"alert alert-info\">æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼Œè¯·ç¨å€™...</div>';\n" +
                "            \n" +
                "            fetch('/api/connection-test', { method: 'POST' })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    lastConnectionTestTime = now;\n" +
                "                    if (data.success !== undefined && data.failed !== undefined) {\n" +
                "                        const total = data.success + data.failed;\n" +
                "                        const successRate = total > 0 ? ((data.success / total) * 100).toFixed(1) : 0;\n" +
                "                        \n" +
                "                        let alertClass = 'alert-success';\n" +
                "                        if (data.failed > 0) {\n" +
                "                            alertClass = data.failed > data.success ? 'alert-error' : 'alert-warning';\n" +
                "                        }\n" +
                "                        \n" +
                "                        resultDiv.innerHTML = `\n" +
                "                            <div class=\"alert ${alertClass}\">\n" +
                "                                <strong>è¿æ¥æµ‹è¯•å®Œæˆ</strong><br>\n" +
                "                                âœ… æˆåŠŸè¿æ¥: ${data.success} ä¸ª<br>\n" +
                "                                âŒ è¿æ¥å¤±è´¥: ${data.failed} ä¸ª<br>\n" +
                "                                ğŸ“Š æˆåŠŸç‡: ${successRate}%<br>\n" +
                "                                ğŸ”„ é»‘åå•å·²è‡ªåŠ¨é‡ç½®\n" +
                "                            </div>\n" +
                "                        `;\n" +
                "                    } else {\n" +
                "                        resultDiv.innerHTML = '<div class=\"alert alert-error\">è¿æ¥æµ‹è¯•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    resultDiv.innerHTML = '<div class=\"alert alert-error\">è¿æ¥æµ‹è¯•å¤±è´¥: ' + err.message + '</div>';\n" +
                "                })\n" +
                "                .finally(() => {\n" +
                "                    btn.disabled = false;\n" +
                "                    loading.classList.remove('show');\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function showCooldownMessage(remainingMinutes) {\n" +
                "            const cooldownDiv = document.getElementById('cooldownInfo');\n" +
                "            cooldownDiv.innerHTML = `\n" +
                "                <strong>â° è¿æ¥æµ‹è¯•é¢‘ç‡é™åˆ¶</strong><br><br>\n" +
                "                ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿæ€§èƒ½ï¼Œè¿æ¥æµ‹è¯•åŠŸèƒ½æ¯10åˆ†é’Ÿåªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚<br><br>\n" +
                "                è¯·ç­‰å¾… ${remainingMinutes} åˆ†é’Ÿåå†è¯•ã€‚<br><br>\n" +
                "                ğŸ’¡ æç¤ºï¼šè¿æ¥æµ‹è¯•ä¼šè‡ªåŠ¨é‡ç½®é»‘åå•å¹¶è¿›è¡Œå…¨é¢çš„æ•°æ®åº“è¿æ¥æ£€æŸ¥\n" +
                "            `;\n" +
                "            cooldownDiv.style.display = 'block';\n" +
                "            \n" +
                "            // 5ç§’åè‡ªåŠ¨éšè—æç¤º\n" +
                "            setTimeout(() => {\n" +
                "                cooldownDiv.style.display = 'none';\n" +
                "            }, 5000);\n" +
                "        }\n" +
                "        \n" +
                "        function encryptConfigurations() {\n" +
                "            const btn = document.getElementById('encryptBtn');\n" +
                "            const loading = document.getElementById('encryptLoading');\n" +
                "            const resultDiv = document.getElementById('encryptResult');\n" +
                "            \n" +
                "            btn.disabled = true;\n" +
                "            loading.classList.add('show');\n" +
                "            resultDiv.innerHTML = '<div class=\"alert alert-info\">æ­£åœ¨åŠ å¯†é…ç½®æ–‡ä»¶ï¼Œè¯·ç¨å€™...</div>';\n" +
                "            \n" +
                "            fetch('/api/encrypt-config', { method: 'POST' })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    if (data.success) {\n" +
                "                        resultDiv.innerHTML = `\n" +
                "                            <div class=\"alert alert-success\">\n" +
                "                                <strong>âœ… é…ç½®åŠ å¯†æˆåŠŸ</strong><br>\n" +
                "                                ${data.message || 'æ‰€æœ‰é…ç½®æ–‡ä»¶å·²ä½¿ç”¨SM4ç®—æ³•åŠ å¯†'}<br>\n" +
                "                                ğŸ” æ•æ„Ÿä¿¡æ¯å·²å®‰å…¨ä¿æŠ¤\n" +
                "                            </div>\n" +
                "                        `;\n" +
                "                    } else {\n" +
                "                        resultDiv.innerHTML = '<div class=\"alert alert-error\">âŒ é…ç½®åŠ å¯†å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    resultDiv.innerHTML = '<div class=\"alert alert-error\">âŒ é…ç½®åŠ å¯†å¤±è´¥: ' + err.message + '</div>';\n" +
                "                })\n" +
                "                .finally(() => {\n" +
                "                    btn.disabled = false;\n" +
                "                    loading.classList.remove('show');\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function generateReport(format) {\n" +
                "            const btn = document.getElementById(format + 'Btn');\n" +
                "            const loading = document.getElementById(format + 'Loading');\n" +
                "            const resultDiv = document.getElementById('reportResult');\n" +
                "            \n" +
                "            btn.disabled = true;\n" +
                "            loading.classList.add('show');\n" +
                "            resultDiv.innerHTML = '<div class=\"alert alert-info\">æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...</div>';\n" +
                "            \n" +
                "            fetch('/api/generate-report', { method: 'POST', body: JSON.stringify({ format: format }) })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    if (data.success) {\n" +
                "                        resultDiv.innerHTML = `\n" +
                "                            <div class=\"alert alert-success\">\n" +
                "                                <strong>âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ</strong><br>\n" +
                "                                ${data.message || 'æŠ¥å‘Šå·²æˆåŠŸç”Ÿæˆ'}<br>\n" +
                "                                ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š: <a href=\"/reports/${data.filename}\" target=\"_blank\">${data.filename}</a>\n" +
                "                            </div>\n" +
                "                        `;\n" +
                "                    } else {\n" +
                "                        resultDiv.innerHTML = '<div class=\"alert alert-error\">âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    resultDiv.innerHTML = '<div class=\"alert alert-error\">âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + err.message + '</div>';\n" +
                "                })\n" +
                "                .finally(() => {\n" +
                "                    btn.disabled = false;\n" +
                "                    loading.classList.remove('show');\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function loadConfigList() {\n" +
                "            fetch('/api/config', { method: 'GET' })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    const configList = document.getElementById('configList');\n" +
                "                    configList.innerHTML = '';\n" +
                "                    \n" +
                "                    if (data && data.length > 0) {\n" +
                "                        data.forEach(config => {\n" +
                "                            const configItem = document.createElement('div');\n" +
                "                            configItem.className = 'config-item';\n" +
                "                            configItem.innerHTML = `\n" +
                "                                <span>${config.name}</span>\n" +
                "                                <div class=\"config-actions\">\n" +
                "                                    <button class=\"btn btn-info\" onclick=\"editConfig('${config.name}')\">ğŸ“ ç¼–è¾‘</button>\n" +
                "                                </div>\n" +
                "                            `;\n" +
                "                            configList.appendChild(configItem);\n" +
                "                        });\n" +
                "                    } else {\n" +
                "                        configList.innerHTML = '<div class=\"alert alert-warning\">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    console.warn('åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥:', err);\n" +
                "                    document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥: ' + err.message + '</div>';\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function createNewConfig() {\n" +
                "            document.getElementById('configFileName').value = '';\n" +
                "            document.getElementById('configContent').value = '';\n" +
                "            document.getElementById('modalTitle').textContent = 'æ–°å»ºé…ç½®æ–‡ä»¶';\n" +
                "            document.getElementById('deleteConfigBtn').style.display = 'none';\n" +
                "            document.getElementById('configModal').style.display = 'block';\n" +
                "        }\n" +
                "        \n" +
                "        function editConfig(filename) {\n" +
                "            fetch('/api/config/' + encodeURIComponent(filename), { method: 'GET' })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    document.getElementById('configFileName').value = data.name;\n" +
                "                    document.getElementById('configContent').value = data.content;\n" +
                "                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é…ç½®æ–‡ä»¶: ' + data.name;\n" +
                "                    document.getElementById('deleteConfigBtn').style.display = 'block';\n" +
                "                    document.getElementById('configModal').style.display = 'block';\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    console.warn('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:', err);\n" +
                "                    document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: ' + err.message + '</div>';\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function saveConfig() {\n" +
                "            const filename = document.getElementById('configFileName').value;\n" +
                "            const content = document.getElementById('configContent').value;\n" +
                "            \n" +
                "            const requestData = {\n" +
                "                fileName: filename,\n" +
                "                content: content\n" +
                "            };\n" +
                "            \n" +
                "            fetch('/api/config', {\n" +
                "                method: 'POST',\n" +
                "                headers: { 'Content-Type': 'application/json' },\n" +
                "                body: JSON.stringify(requestData)\n" +
                "            })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    if (data.success) {\n" +
                "                        document.getElementById('configResult').innerHTML = '<div class=\"alert alert-success\">é…ç½®æ–‡ä»¶å·²ä¿å­˜</div>';\n" +
                "                        loadConfigList();\n" +
                "                        closeConfigModal();\n" +
                "                    } else {\n" +
                "                        document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥: ' + err.message + '</div>';\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        function deleteConfig() {\n" +
                "            const filename = document.getElementById('configFileName').value;\n" +
                "            \n" +
                "            if (!confirm('ç¡®å®šè¦åˆ é™¤é…ç½®æ–‡ä»¶ \"' + filename + '\" å—ï¼Ÿ')) {\n" +
                "                return;\n" +
                "            }\n" +
                "            \n" +
                "            fetch('/api/config/' + encodeURIComponent(filename), { method: 'DELETE' })\n" +
                "                .then(response => response.json())\n" +
                "                .then(data => {\n" +
                "                    if (data.success) {\n" +
                "                        document.getElementById('configResult').innerHTML = '<div class=\"alert alert-success\">é…ç½®æ–‡ä»¶å·²åˆ é™¤</div>';\n" +
                "                        loadConfigList();\n" +
                "                        closeConfigModal();\n" +
                "                    } else {\n" +
                "                        document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">åˆ é™¤é…ç½®æ–‡ä»¶å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';\n" +
                "                    }\n" +
                "                })\n" +
                "                .catch(err => {\n" +
                "                    document.getElementById('configResult').innerHTML = '<div class=\"alert alert-error\">åˆ é™¤é…ç½®æ–‡ä»¶å¤±è´¥: ' + err.message + '</div>';\n" +
                "                });\n" +
                "        }\n" +
                "        \n" +
                "        // é¡µé¢å¸è½½æ—¶åœæ­¢æ—¥å¿—åˆ·æ–°\n" +
                "        window.addEventListener('beforeunload', function() {\n" +
                "            stopLogRefresh();\n" +
                "        });\n" +
                "    </script>\n" +
                "</body>\n" +
                "</html>";
        }
    }
    
    /**
     * æ•°æ®åº“è¿æ¥æµ‹è¯•å¤„ç†å™¨
     */
    private class ConnectionTestHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            if (!"POST".equals(exchange.getRequestMethod())) {
                sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                return;
            }
            
            // æ£€æŸ¥é¢‘ç‡é™åˆ¶
            long now = System.currentTimeMillis();
            if (now - lastConnectionTestTime < CONNECTION_TEST_COOLDOWN) {
                long remainingTime = (CONNECTION_TEST_COOLDOWN - (now - lastConnectionTestTime)) / 1000 / 60;
                String response = String.format(
                    "{\"error\": \"é¢‘ç‡é™åˆ¶\", \"message\": \"è¯·ç­‰å¾… %d åˆ†é’Ÿåå†è¯•\", \"remainingTime\": %d}",
                    remainingTime, remainingTime
                );
                sendResponse(exchange, 429, response, "application/json");
                return;
            }
            
            try {
                // é‡ç½®é»‘åå•
                resetBlacklist();
                
                // æ‰§è¡Œè¿æ¥æµ‹è¯•
                ConfigLoader configLoader = new ConfigLoader(new EncryptionService());
                Map<String, DatabaseConfig> databaseConfigs = configLoader.loadDatabaseConfigs(config.getConfigPath());
                
                ConnectionFactory connectionFactory = new ConnectionFactory();
                FastConnectionTestService connectionTestService = new FastConnectionTestService(connectionFactory, config.getConcurrency());
                
                // æ„é€ æµ‹è¯•æ•°æ®ç»“æ„
                Map<String, Map<String, DatabaseConfig>> testConfigs = new HashMap<>();
                for (Map.Entry<String, DatabaseConfig> entry : databaseConfigs.entrySet()) {
                    String systemName = entry.getKey();
                    DatabaseConfig dbConfig = entry.getValue();
                    
                    if (!dbConfig.isEnable()) {
                        continue;
                    }
                    
                    String dbType = dbConfig.getType() != null ? dbConfig.getType() : "unknown";
                    testConfigs.computeIfAbsent(dbType, k -> new HashMap<>()).put(systemName, dbConfig);
                }
                
                // æ‰§è¡Œæµ‹è¯•
                boolean testResult = connectionTestService.testConnectionsWithNames(testConfigs);
                
                // è®¡ç®—æˆåŠŸå’Œå¤±è´¥æ•°é‡
                int totalEnabled = 0;
                for (Map.Entry<String, Map<String, DatabaseConfig>> entry : testConfigs.entrySet()) {
                    totalEnabled += entry.getValue().size();
                }
                
                int failed = connectionTestService.getFailedEncryptedHosts().size();
                int success = Math.max(0, totalEnabled - failed);
                
                // æ›´æ–°æœ€åæµ‹è¯•æ—¶é—´
                lastConnectionTestTime = now;
                
                String response = String.format(
                    "{\"success\": %d, \"failed\": %d, \"total\": %d}",
                    success, failed, totalEnabled
                );
                sendResponse(exchange, 200, response, "application/json");
                
            } catch (Exception e) {
                logger.error("è¿æ¥æµ‹è¯•å¤±è´¥", e);
                String response = String.format(
                    "{\"success\": 0, \"failed\": 0, \"error\": \"%s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private void resetBlacklist() {
            try {
                Path blacklistPath = Paths.get("logs/db_conn_blacklist.txt");
                if (Files.exists(blacklistPath)) {
                    Files.delete(blacklistPath);
                    logger.info("é»‘åå•æ–‡ä»¶å·²é‡ç½®");
                }
            } catch (IOException e) {
                logger.warn("é‡ç½®é»‘åå•æ–‡ä»¶å¤±è´¥: {}", e.getMessage());
            }
        }
    }
    
    /**
     * é…ç½®åŠ å¯†å¤„ç†å™¨
     */
    private class EncryptConfigHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            if (!"POST".equals(exchange.getRequestMethod())) {
                sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                return;
            }
            
            try {
                EncryptionService encryptionService = new EncryptionService();
                encryptionService.encryptConfigs(config.getConfigPath());
                
                String response = "{\"success\": true, \"message\": \"é…ç½®æ–‡ä»¶å·²æˆåŠŸä½¿ç”¨SM4ç®—æ³•åŠ å¯†\"}";
                sendResponse(exchange, 200, response, "application/json");
                
            } catch (Exception e) {
                logger.error("é…ç½®åŠ å¯†å¤±è´¥", e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"%s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
    }
    
    /**
     * æŠ¥å‘Šç”Ÿæˆå¤„ç†å™¨
     */
    private class ReportGenerationHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            if (!"POST".equals(exchange.getRequestMethod())) {
                sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                return;
            }
            
            try {
                // è¯»å–è¯·æ±‚ä½“
                String requestBody = new String(exchange.getRequestBody().readAllBytes(), StandardCharsets.UTF_8);
                String format = "both";
                
                // è§£æJSONè¯·æ±‚ä½“
                if (requestBody != null && !requestBody.isEmpty()) {
                    // æ›´å‡†ç¡®çš„JSONè§£æ
                    if (requestBody.contains("\"format\":\"excel\"")) {
                        format = "excel";
                    } else if (requestBody.contains("\"format\":\"html\"")) {
                        format = "html";
                    } else if (requestBody.contains("\"format\":\"both\"")) {
                        format = "both";
                    }
                }
                
                // åˆ›å»ºæŠ¥å‘Šé…ç½®
                AppConfig reportConfig = new AppConfig();
                reportConfig.setConfigPath(config.getConfigPath());
                reportConfig.setMetricsPath(config.getMetricsPath());
                reportConfig.setOutputPath(config.getOutputPath());
                reportConfig.setConcurrency(config.getConcurrency());
                reportConfig.setOutputFormat(format);
                
                // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
                Path outputDir = Paths.get(config.getOutputPath());
                if (!Files.exists(outputDir)) {
                    Files.createDirectories(outputDir);
                }
                
                // ç”ŸæˆæŠ¥å‘Š
                DbCliRunner runner = new DbCliRunner(reportConfig);
                boolean success = runner.run();
                
                if (success) {
                    String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
                    String fileName = "";
                    String previewUrl = "";
                    
                    if ("excel".equals(format)) {
                        fileName = "db_report_" + timestamp + ".xlsx";
                        previewUrl = "reports/db_report_" + timestamp + ".xlsx";
                    } else if ("html".equals(format)) {
                        fileName = "db_metrics_report_" + timestamp + ".html";
                        previewUrl = "reports/db_metrics_report_" + timestamp + ".html";
                    } else {
                        fileName = "db_report_" + timestamp + ".xlsx å’Œ db_metrics_report_" + timestamp + ".html";
                        previewUrl = "reports/db_metrics_report_" + timestamp + ".html";
                    }
                    
                    String response = String.format(
                        "{\"success\": true, \"message\": \"æŠ¥å‘Šå·²æˆåŠŸç”Ÿæˆåˆ° %s ç›®å½•\", \"fileName\": \"%s\", \"previewUrl\": \"%s\"}",
                        config.getOutputPath(), fileName, previewUrl
                    );
                    sendResponse(exchange, 200, response, "application/json");
                } else {
                    sendResponse(exchange, 500, "{\"success\": false, \"message\": \"æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯\"}", "application/json");
                }
                
            } catch (Exception e) {
                logger.error("æŠ¥å‘Šç”Ÿæˆå¤±è´¥", e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"æŠ¥å‘Šç”Ÿæˆå¤±è´¥: %s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
    }
    
    /**
     * å®æ—¶æ—¥å¿—å¤„ç†å™¨
     */
    private class RealTimeLogsHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            if (!"GET".equals(exchange.getRequestMethod())) {
                sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                return;
            }
            
            try {
                List<String> logLines = readRecentLogs();
                
                // æ„å»ºJSONå“åº”
                StringBuilder jsonBuilder = new StringBuilder();
                jsonBuilder.append("{\"logs\": [");
                
                for (int i = 0; i < logLines.size(); i++) {
                    if (i > 0) jsonBuilder.append(",");
                    jsonBuilder.append("\"")
                        .append(logLines.get(i).replace("\"", "\\\"").replace("\n", "\\n").replace("\r", ""))
                        .append("\"");
                }
                
                jsonBuilder.append("]}");
                
                sendResponse(exchange, 200, jsonBuilder.toString(), "application/json");
                
            } catch (Exception e) {
                logger.error("è¯»å–æ—¥å¿—å¤±è´¥", e);
                String response = String.format(
                    "{\"logs\": [\"[ERROR] è¯»å–æ—¥å¿—å¤±è´¥: %s\"]}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private List<String> readRecentLogs() {
            List<String> logLines = new ArrayList<>();
            
            // å°è¯•è¯»å–å¤šä¸ªæ—¥å¿—æ–‡ä»¶
            String[] logFiles = {
                "logs/application.log",
                "logs/db_conn_error.txt",
                "logs/execution/execution.log"
            };
            
            for (String logFile : logFiles) {
                Path logPath = Paths.get(logFile);
                if (Files.exists(logPath)) {
                    try (BufferedReader reader = Files.newBufferedReader(logPath, StandardCharsets.UTF_8)) {
                        List<String> allLines = new ArrayList<>();
                        String line;
                        
                        // è¯»å–æ‰€æœ‰è¡Œ
                        while ((line = reader.readLine()) != null) {
                            if (line.trim().length() > 0) {
                                allLines.add(line);
                            }
                        }
                        
                        // åªå–æœ€å50è¡Œ
                        int startIndex = Math.max(0, allLines.size() - 50);
                        logLines.addAll(allLines.subList(startIndex, allLines.size()));
                        
                        if (logLines.size() >= 50) break; // æœ‰è¶³å¤Ÿçš„æ—¥å¿—å°±åœæ­¢
                        
                    } catch (IOException e) {
                        // å¿½ç•¥å•ä¸ªæ–‡ä»¶çš„è¯»å–é”™è¯¯
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰è¯»å–åˆ°æ—¥å¿—ï¼Œæ·»åŠ é»˜è®¤æ¶ˆæ¯
            if (logLines.isEmpty()) {
                logLines.add("[INFO] " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")) + " ç³»ç»Ÿè¿è¡Œæ­£å¸¸");
                logLines.add("[INFO] " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")) + " Webç®¡ç†ç•Œé¢å·²å¯åŠ¨");
            }
            
            // æ·»åŠ æ—¶é—´æˆ³
            logLines.add("[SYSTEM] " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss.SSS")) + " æ—¥å¿—åˆ·æ–°å®Œæˆ");
            
            return logLines;
        }
    }
    
    /**
     * çŠ¶æ€å¤„ç†å™¨
     */
    private class StatusHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            String response = String.format(
                "{\"status\": \"running\", \"uptime\": \"%s\", \"version\": \"2.1.0\", \"timestamp\": \"%s\"}",
                "è¿è¡Œä¸­", LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
            );
            sendResponse(exchange, 200, response, "application/json");
        }
    }
    
    /**
     * é…ç½®ç®¡ç†å¤„ç†å™¨ - ç”¨äºæŸ¥çœ‹ã€ç¼–è¾‘å’Œæ›´æ–°æ•°æ®åº“é…ç½®æ–‡ä»¶
     */
    private class ConfigManagementHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            String requestMethod = exchange.getRequestMethod();
            String requestPath = exchange.getRequestURI().getPath();
            
            try {
                if ("GET".equals(requestMethod)) {
                    // è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨æˆ–ç‰¹å®šé…ç½®æ–‡ä»¶å†…å®¹
                    handleGetConfig(exchange, requestPath);
                } else if ("POST".equals(requestMethod) || "PUT".equals(requestMethod)) {
                    // æ›´æ–°é…ç½®æ–‡ä»¶
                    handleUpdateConfig(exchange, requestPath);
                } else if ("DELETE".equals(requestMethod)) {
                    // åˆ é™¤é…ç½®æ–‡ä»¶
                    handleDeleteConfig(exchange, requestPath);
                } else {
                    sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                }
            } catch (Exception e) {
                logger.error("é…ç½®ç®¡ç†å¤„ç†å¤±è´¥", e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"%s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private void handleGetConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            String metricsPath = config.getMetricsPath();
            Path configDir = Paths.get(configPath);
            Path metricsDir = Paths.get(metricsPath);
            
            if (!Files.exists(configDir) && !Files.exists(metricsDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config and metrics directories not found\"}", "application/json");
                return;
            }
            
            // å¦‚æœè¯·æ±‚è·¯å¾„æ˜¯ /api/config/ï¼Œè¿”å›é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼ˆåŒ…æ‹¬æ•°æ®åº“é…ç½®å’ŒæŒ‡æ ‡é…ç½®ï¼‰
            if ("/api/config".equals(requestPath) || "/api/config/".equals(requestPath)) {
                List<Map<String, Object>> configFiles = new ArrayList<>();
                
                // æ·»åŠ æ•°æ®åº“é…ç½®æ–‡ä»¶
                if (Files.exists(configDir)) {
                    try (var paths = Files.walk(configDir)) {
                        paths.filter(path -> {
                            String fileName = path.getFileName().toString().toLowerCase();
                            return fileName.endsWith("-config.yml") || fileName.endsWith("-config.yaml");
                        }).forEach(path -> {
                            try {
                                Map<String, Object> fileInfo = new HashMap<>();
                                fileInfo.put("name", path.getFileName().toString());
                                fileInfo.put("path", configDir.relativize(path).toString());
                                fileInfo.put("type", "database");
                                fileInfo.put("size", Files.size(path));
                                fileInfo.put("lastModified", Files.getLastModifiedTime(path).toString());
                                configFiles.add(fileInfo);
                            } catch (IOException e) {
                                logger.warn("è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯å¤±è´¥: {}", path, e);
                            }
                        });
                    } catch (IOException e) {
                        logger.error("éå†é…ç½®ç›®å½•å¤±è´¥", e);
                    }
                }
                
                // æ·»åŠ æŒ‡æ ‡é…ç½®æ–‡ä»¶
                if (Files.exists(metricsDir)) {
                    try (var paths = Files.walk(metricsDir)) {
                        paths.filter(path -> {
                            String fileName = path.getFileName().toString().toLowerCase();
                            return fileName.endsWith("-metrics.yml") || fileName.endsWith("-metrics.yaml");
                        }).forEach(path -> {
                            try {
                                Map<String, Object> fileInfo = new HashMap<>();
                                fileInfo.put("name", path.getFileName().toString());
                                fileInfo.put("path", metricsDir.relativize(path).toString());
                                fileInfo.put("type", "metrics");
                                fileInfo.put("size", Files.size(path));
                                fileInfo.put("lastModified", Files.getLastModifiedTime(path).toString());
                                configFiles.add(fileInfo);
                            } catch (IOException e) {
                                logger.warn("è¯»å–æŒ‡æ ‡é…ç½®æ–‡ä»¶ä¿¡æ¯å¤±è´¥: {}", path, e);
                            }
                        });
                    } catch (IOException e) {
                        logger.error("éå†æŒ‡æ ‡é…ç½®ç›®å½•å¤±è´¥", e);
                    }
                }
                
                String response = toJson(configFiles);
                sendResponse(exchange, 200, response, "application/json");
            } else {
                // è¿”å›ç‰¹å®šé…ç½®æ–‡ä»¶çš„å†…å®¹
                String fileName = requestPath.substring("/api/config/".length());
                
                // å…ˆåœ¨æ•°æ®åº“é…ç½®ç›®å½•ä¸­æŸ¥æ‰¾
                Path configFile = configDir.resolve(fileName);
                if (!Files.exists(configFile)) {
                    // å¦‚æœåœ¨æ•°æ®åº“é…ç½®ç›®å½•ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨æŒ‡æ ‡é…ç½®ç›®å½•ä¸­æŸ¥æ‰¾
                    configFile = metricsDir.resolve(fileName);
                }
                
                if (!Files.exists(configFile)) {
                    sendResponse(exchange, 404, "{\"error\": \"Config file not found\"}", "application/json");
                    return;
                }
                
                try {
                    String content = Files.readString(configFile, StandardCharsets.UTF_8);
                    Map<String, Object> result = new HashMap<>();
                    result.put("name", fileName);
                    result.put("content", content);
                    String response = toJson(result);
                    sendResponse(exchange, 200, response, "application/json");
                } catch (IOException e) {
                    logger.error("è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                    String response = String.format(
                        "{\"error\": \"Failed to read config file: %s\"}",
                        e.getMessage().replace("\"", "\\\"")
                    );
                    sendResponse(exchange, 500, response, "application/json");
                }
            }
        }
        
        private void handleUpdateConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            String metricsPath = config.getMetricsPath();
            Path configDir = Paths.get(configPath);
            Path metricsDir = Paths.get(metricsPath);
            
            if (!Files.exists(configDir) && !Files.exists(metricsDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config and metrics directories not found\"}", "application/json");
                return;
            }
            
            // è¯»å–è¯·æ±‚ä½“
            String requestBody = new String(exchange.getRequestBody().readAllBytes(), StandardCharsets.UTF_8);
            Map<String, Object> requestData = parseJson(requestBody);
            
            String fileName = (String) requestData.get("fileName");
            String content = (String) requestData.get("content");
            String fileType = (String) requestData.get("type"); // "database" or "metrics"
            
            if (fileName == null || content == null) {
                sendResponse(exchange, 400, "{\"error\": \"Missing fileName or content\"}", "application/json");
                return;
            }
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šä¿å­˜ç›®å½•
            Path configFile;
            if ("metrics".equals(fileType)) {
                configFile = metricsDir.resolve(fileName);
            } else {
                // é»˜è®¤ä¿å­˜åˆ°æ•°æ®åº“é…ç½®ç›®å½•
                configFile = configDir.resolve(fileName);
            }
            
            try {
                // ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
                Files.createDirectories(configFile.getParent());
                
                // å†™å…¥æ–‡ä»¶
                Files.writeString(configFile, content, StandardCharsets.UTF_8);
                
                String response = "{\"success\": true, \"message\": \"é…ç½®æ–‡ä»¶æ›´æ–°æˆåŠŸ\"}";
                sendResponse(exchange, 200, response, "application/json");
            } catch (IOException e) {
                logger.error("å†™å…¥é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"Failed to write config file: %s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private void handleDeleteConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            String metricsPath = config.getMetricsPath();
            Path configDir = Paths.get(configPath);
            Path metricsDir = Paths.get(metricsPath);
            
            if (!Files.exists(configDir) && !Files.exists(metricsDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config and metrics directories not found\"}", "application/json");
                return;
            }
            
            String fileName = requestPath.substring("/api/config/".length());
            
            // å…ˆåœ¨æ•°æ®åº“é…ç½®ç›®å½•ä¸­æŸ¥æ‰¾
            Path configFile = configDir.resolve(fileName);
            if (!Files.exists(configFile)) {
                // å¦‚æœåœ¨æ•°æ®åº“é…ç½®ç›®å½•ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åœ¨æŒ‡æ ‡é…ç½®ç›®å½•ä¸­æŸ¥æ‰¾
                configFile = metricsDir.resolve(fileName);
            }
            
            if (!Files.exists(configFile)) {
                sendResponse(exchange, 404, "{\"error\": \"Config file not found\"}", "application/json");
                return;
            }
            
            try {
                Files.delete(configFile);
                String response = "{\"success\": true, \"message\": \"é…ç½®æ–‡ä»¶åˆ é™¤æˆåŠŸ\"}";
                sendResponse(exchange, 200, response, "application/json");
            } catch (IOException e) {
                logger.error("åˆ é™¤é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"Failed to delete config file: %s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
    }
    
    /**
     * é…ç½®ç®¡ç†å¤„ç†å™¨ - ç”¨äºæŸ¥çœ‹ã€ç¼–è¾‘å’Œæ›´æ–°æ•°æ®åº“é…ç½®æ–‡ä»¶
     */
    private class ConfigManagementHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            String requestMethod = exchange.getRequestMethod();
            String requestPath = exchange.getRequestURI().getPath();
            
            try {
                if ("GET".equals(requestMethod)) {
                    // è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨æˆ–ç‰¹å®šé…ç½®æ–‡ä»¶å†…å®¹
                    handleGetConfig(exchange, requestPath);
                } else if ("POST".equals(requestMethod) || "PUT".equals(requestMethod)) {
                    // æ›´æ–°é…ç½®æ–‡ä»¶
                    handleUpdateConfig(exchange, requestPath);
                } else if ("DELETE".equals(requestMethod)) {
                    // åˆ é™¤é…ç½®æ–‡ä»¶
                    handleDeleteConfig(exchange, requestPath);
                } else {
                    sendResponse(exchange, 405, "{\"error\": \"Method not allowed\"}", "application/json");
                }
            } catch (Exception e) {
                logger.error("é…ç½®ç®¡ç†å¤„ç†å¤±è´¥", e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"%s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private void handleGetConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            Path configDir = Paths.get(configPath);
            
            if (!Files.exists(configDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config directory not found\"}", "application/json");
                return;
            }
            
            // å¦‚æœè¯·æ±‚è·¯å¾„æ˜¯ /api/config/ï¼Œè¿”å›é…ç½®æ–‡ä»¶åˆ—è¡¨
            if ("/api/config".equals(requestPath) || "/api/config/".equals(requestPath)) {
                List<Map<String, Object>> configFiles = new ArrayList<>();
                
                try (var paths = Files.walk(configDir)) {
                    paths.filter(path -> {
                        String fileName = path.getFileName().toString().toLowerCase();
                        return fileName.endsWith("-config.yml") || fileName.endsWith("-config.yaml");
                    }).forEach(path -> {
                        try {
                            Map<String, Object> fileInfo = new HashMap<>();
                            fileInfo.put("name", path.getFileName().toString());
                            fileInfo.put("path", configDir.relativize(path).toString());
                            fileInfo.put("size", Files.size(path));
                            fileInfo.put("lastModified", Files.getLastModifiedTime(path).toString());
                            configFiles.add(fileInfo);
                        } catch (IOException e) {
                            logger.warn("è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯å¤±è´¥: {}", path, e);
                        }
                    });
                } catch (IOException e) {
                    logger.error("éå†é…ç½®ç›®å½•å¤±è´¥", e);
                }
                
                String response = toJson(configFiles);
                sendResponse(exchange, 200, response, "application/json");
            } else {
                // è¿”å›ç‰¹å®šé…ç½®æ–‡ä»¶çš„å†…å®¹
                String fileName = requestPath.substring("/api/config/".length());
                Path configFile = configDir.resolve(fileName);
                
                if (!Files.exists(configFile)) {
                    sendResponse(exchange, 404, "{\"error\": \"Config file not found\"}", "application/json");
                    return;
                }
                
                try {
                    String content = Files.readString(configFile, StandardCharsets.UTF_8);
                    Map<String, Object> result = new HashMap<>();
                    result.put("name", fileName);
                    result.put("content", content);
                    String response = toJson(result);
                    sendResponse(exchange, 200, response, "application/json");
                } catch (IOException e) {
                    logger.error("è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                    String response = String.format(
                        "{\"error\": \"Failed to read config file: %s\"}",
                        e.getMessage().replace("\"", "\\\"")
                    );
                    sendResponse(exchange, 500, response, "application/json");
                }
            }
        }
        
        private void handleUpdateConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            Path configDir = Paths.get(configPath);
            
            if (!Files.exists(configDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config directory not found\"}", "application/json");
                return;
            }
            
            // è¯»å–è¯·æ±‚ä½“
            String requestBody = new String(exchange.getRequestBody().readAllBytes(), StandardCharsets.UTF_8);
            Map<String, Object> requestData = parseJson(requestBody);
            
            String fileName = (String) requestData.get("fileName");
            String content = (String) requestData.get("content");
            
            if (fileName == null || content == null) {
                sendResponse(exchange, 400, "{\"error\": \"Missing fileName or content\"}", "application/json");
                return;
            }
            
            Path configFile = configDir.resolve(fileName);
            
            try {
                // å†™å…¥æ–‡ä»¶
                Files.writeString(configFile, content, StandardCharsets.UTF_8);
                
                String response = "{\"success\": true, \"message\": \"é…ç½®æ–‡ä»¶æ›´æ–°æˆåŠŸ\"}";
                sendResponse(exchange, 200, response, "application/json");
            } catch (IOException e) {
                logger.error("å†™å…¥é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"Failed to write config file: %s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private void handleDeleteConfig(HttpExchange exchange, String requestPath) throws IOException {
            String configPath = config.getConfigPath();
            Path configDir = Paths.get(configPath);
            
            if (!Files.exists(configDir)) {
                sendResponse(exchange, 404, "{\"error\": \"Config directory not found\"}", "application/json");
                return;
            }
            
            String fileName = requestPath.substring("/api/config/".length());
            Path configFile = configDir.resolve(fileName);
            
            if (!Files.exists(configFile)) {
                sendResponse(exchange, 404, "{\"error\": \"Config file not found\"}", "application/json");
                return;
            }
            
            try {
                Files.delete(configFile);
                String response = "{\"success\": true, \"message\": \"é…ç½®æ–‡ä»¶åˆ é™¤æˆåŠŸ\"}";
                sendResponse(exchange, 200, response, "application/json");
            } catch (IOException e) {
                logger.error("åˆ é™¤é…ç½®æ–‡ä»¶å¤±è´¥: {}", configFile, e);
                String response = String.format(
                    "{\"success\": false, \"message\": \"Failed to delete config file: %s\"}",
                    e.getMessage().replace("\"", "\\\"")
                );
                sendResponse(exchange, 500, response, "application/json");
            }
        }
        
        private Map<String, Object> parseJson(String json) {
            // ç®€å•çš„JSONè§£æå®ç°
            Map<String, Object> result = new HashMap<>();
            try {
                // ç§»é™¤é¦–å°¾çš„å¤§æ‹¬å·
                String content = json.trim();
                if (content.startsWith("{") && content.endsWith("}")) {
                    content = content.substring(1, content.length() - 1);
                }
                
                // æŒ‰é€—å·åˆ†å‰²é”®å€¼å¯¹
                String[] pairs = content.split(",");
                for (String pair : pairs) {
                    String[] keyValue = pair.split(":", 2);
                    if (keyValue.length == 2) {
                        String key = keyValue[0].trim().replaceAll("^\"|\"$", ""); // å»æ‰å¼•å·
                        String value = keyValue[1].trim().replaceAll("^\"|\"$", ""); // å»æ‰å¼•å·
                        result.put(key, value);
                    }
                }
            } catch (Exception e) {
                logger.warn("JSONè§£æå¤±è´¥: {}", e.getMessage());
            }
            return result;
        }
        
        private String toJson(Object obj) {
            if (obj instanceof List) {
                List<?> list = (List<?>) obj;
                StringBuilder sb = new StringBuilder("[");
                for (int i = 0; i < list.size(); i++) {
                    if (i > 0) sb.append(",");
                    sb.append(toJson(list.get(i)));
                }
                sb.append("]");
                return sb.toString();
            } else if (obj instanceof Map) {
                Map<?, ?> map = (Map<?, ?>) obj;
                StringBuilder sb = new StringBuilder("{");
                int i = 0;
                for (Map.Entry<?, ?> entry : map.entrySet()) {
                    if (i > 0) sb.append(",");
                    sb.append("\"").append(entry.getKey().toString().replace("\"", "\\\"")).append("\":");
                    sb.append(toJson(entry.getValue()));
                    i++;
                }
                sb.append("}");
                return sb.toString();
            } else if (obj instanceof String) {
                return "\"" + obj.toString().replace("\"", "\\\"") + "\"";
            } else {
                return obj != null ? obj.toString() : "null";
            }
        }
    }
    
    /**
     * é™æ€æ–‡ä»¶å¤„ç†å™¨ - ç”¨äºæä¾›HTMLæŠ¥å‘Šç­‰é™æ€æ–‡ä»¶
     */
    private class StaticFileHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            setCorsHeaders(exchange);
            
            if ("OPTIONS".equals(exchange.getRequestMethod())) {
                exchange.sendResponseHeaders(200, -1);
                return;
            }
            
            String requestPath = exchange.getRequestURI().getPath();
            logger.info("è¯·æ±‚é™æ€æ–‡ä»¶: {}", requestPath);
            
            // ç§»é™¤ /reports/ å‰ç¼€ï¼Œè·å–å®é™…æ–‡ä»¶è·¯å¾„
            String filePath = requestPath.substring("/reports/".length());
            Path reportFile = Paths.get("reports", filePath);
            
            logger.info("æŸ¥æ‰¾æŠ¥å‘Šæ–‡ä»¶: {}", reportFile.toAbsolutePath());
            
            if (!Files.exists(reportFile)) {
                logger.warn("æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨: {}", reportFile.toAbsolutePath());
                String notFoundResponse = "<!DOCTYPE html><html><head><title>æ–‡ä»¶æœªæ‰¾åˆ°</title></head><body>" +
                    "<h1>404 - æ–‡ä»¶æœªæ‰¾åˆ°</h1>" +
                    "<p>è¯·æ±‚çš„æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨: " + filePath + "</p>" +
                    "<p>è¯·å…ˆç”ŸæˆæŠ¥å‘Šï¼Œç„¶åå†è®¿é—®ã€‚</p>" +
                    "<a href=\"/\">è¿”å›ä¸»é¡µ</a>" +
                    "</body></html>";
                sendResponse(exchange, 404, notFoundResponse, "text/html");
                return;
            }
            
            try {
                // è¯»å–æ–‡ä»¶å†…å®¹
                byte[] fileContent = Files.readAllBytes(reportFile);
                
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šContent-Type
                String contentType = getContentType(filePath);
                
                logger.info("æˆåŠŸè¯»å–æŠ¥å‘Šæ–‡ä»¶: {}, å¤§å°: {} bytes, ç±»å‹: {}", 
                    reportFile.getFileName(), fileContent.length, contentType);
                
                // è®¾ç½®å“åº”å¤´
                exchange.getResponseHeaders().set("Content-Type", contentType + "; charset=UTF-8");
                exchange.getResponseHeaders().set("Cache-Control", "no-cache");
                setCorsHeaders(exchange);
                
                // å‘é€æ–‡ä»¶å†…å®¹
                exchange.sendResponseHeaders(200, fileContent.length);
                try (OutputStream os = exchange.getResponseBody()) {
                    os.write(fileContent);
                }
                
            } catch (IOException e) {
                logger.error("è¯»å–æŠ¥å‘Šæ–‡ä»¶å¤±è´¥: {}", e.getMessage(), e);
                String errorResponse = "<!DOCTYPE html><html><head><title>è¯»å–é”™è¯¯</title></head><body>" +
                    "<h1>500 - æœåŠ¡å™¨é”™è¯¯</h1>" +
                    "<p>è¯»å–æŠ¥å‘Šæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage() + "</p>" +
                    "<a href=\"/\">è¿”å›ä¸»é¡µ</a>" +
                    "</body></html>";
                sendResponse(exchange, 500, errorResponse, "text/html");
            }
        }
        
        private String getContentType(String filePath) {
            String lowerPath = filePath.toLowerCase();
            if (lowerPath.endsWith(".html") || lowerPath.endsWith(".htm")) {
                return "text/html";
            } else if (lowerPath.endsWith(".css")) {
                return "text/css";
            } else if (lowerPath.endsWith(".js")) {
                return "application/javascript";
            } else if (lowerPath.endsWith(".json")) {
                return "application/json";
            } else if (lowerPath.endsWith(".xml")) {
                return "application/xml";
            } else if (lowerPath.endsWith(".xlsx")) {
                return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            } else if (lowerPath.endsWith(".xls")) {
                return "application/vnd.ms-excel";
            } else {
                return "text/plain";
            }
        }
    }
    
    /**
     * è®¾ç½®CORSå¤´
     */
    private void setCorsHeaders(HttpExchange exchange) {
        exchange.getResponseHeaders().set("Access-Control-Allow-Origin", "*");
        exchange.getResponseHeaders().set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
        exchange.getResponseHeaders().set("Access-Control-Allow-Headers", "Content-Type, Authorization");
    }
    
    /**
     * å‘é€HTTPå“åº”
     */
    private static void sendResponse(HttpExchange exchange, int statusCode, String response, String contentType) throws IOException {
        exchange.getResponseHeaders().set("Content-Type", contentType + "; charset=UTF-8");
        exchange.getResponseHeaders().set("Access-Control-Allow-Origin", "*");
        exchange.getResponseHeaders().set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
        exchange.getResponseHeaders().set("Access-Control-Allow-Headers", "Content-Type, Authorization");
        
        byte[] responseBytes = response.getBytes(StandardCharsets.UTF_8);
        exchange.sendResponseHeaders(statusCode, responseBytes.length);
        
        try (OutputStream os = exchange.getResponseBody()) {
            os.write(responseBytes);
        }
    }
}